<?php /*

 Composr
 Copyright (c) ocProducts, 2004-2019

 See text/EN/licence.txt for full licensing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

/**
 * @license    http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright  ocProducts Ltd
 * @package    setupwizard
 */

/**
 * Module page class.
 */
class Module_admin_setupwizard
{
    /**
     * Find details of the module.
     *
     * @return ?array Map of module info (null: module is disabled)
     */
    public function info()
    {
        $info = array();
        $info['author'] = 'Chris Graham';
        $info['organisation'] = 'ocProducts';
        $info['hacked_by'] = null;
        $info['hack_version'] = null;
        $info['version'] = 2;
        $info['locked'] = false;
        return $info;
    }

    /**
     * Find entry-points available within this module.
     *
     * @param  boolean $check_perms Whether to check permissions
     * @param  ?MEMBER $member_id The member to check permissions as (null: current user)
     * @param  boolean $support_crosslinks Whether to allow cross links to other modules (identifiable via a full-page-link rather than a screen-name)
     * @param  boolean $be_deferential Whether to avoid any entry-point (or even return null to disable the page in the Sitemap) if we know another module, or page_group, is going to link to that entry-point. Note that "!" and "browse" entry points are automatically merged with container page nodes (likely called by page-groupings) as appropriate.
     * @return ?array A map of entry points (screen-name=>language-code/string or screen-name=>[language-code/string, icon-theme-image]) (null: disabled)
     */
    public function get_entry_points($check_perms = true, $member_id = null, $support_crosslinks = true, $be_deferential = false)
    {
        if (!addon_installed('setupwizard')) {
            return null;
        }

        return array(
            'browse' => array('SETUPWIZARD', 'menu/adminzone/setup/setupwizard'),
            'install_test_content' => array('INSTALL_TEST_CONTENT', 'admin/add_one_category'),
            'uninstall_test_content' => array('UNINSTALL_TEST_CONTENT', 'buttons/clear'),
        );
    }

    public $title;

    /**
     * Module pre-run function. Allows us to know metadata for <head> before we start streaming output.
     *
     * @return ?Tempcode Tempcode indicating some kind of exceptional output (null: none)
     */
    public function pre_run()
    {
        $error_msg = new Tempcode();
        if (!addon_installed__messaged('setupwizard', $error_msg)) {
            return $error_msg;
        }

        require_code('form_templates'); // Needs to run high so that the anti-click-hacking header is sent

        $type = get_param_string('type', 'browse');

        require_lang('config');

        set_helper_panel_tutorial('tut_configuration');

        breadcrumb_set_self(do_lang_tempcode('SETUPWIZARD'));

        if ($type == 'browse') {
            $step = 1;
        }

        if ($type != 'browse') {
            //breadcrumb_set_parents(array(array('_SELF:_SELF:browse', do_lang_tempcode('START'))));

            $step = min(10, intval(substr($type, 4)));
        }

        if ($type == 'install_test_content') {
            $this->title = get_screen_title('INSTALL_TEST_CONTENT');
        }
        elseif ($type == 'uninstall_test_content') {
            $this->title = get_screen_title('UNINSTALL_TEST_CONTENT');
        } else {
            $this->title = get_screen_title('SETUPWIZARD');
        }

        return null;
    }

    /**
     * Execute the module.
     *
     * @return Tempcode The result of execution
     */
    public function run()
    {
        appengine_live_guard();

        require_css('setupwizard');

        $type = get_param_string('type', 'browse');

        if (($type != 'browse') && ($type != 'step11') && ($type != 'install_test_content') && ($type != 'uninstall_test_content')) {
            if ((count($_POST) == 0) && ($_SERVER['REQUEST_METHOD'] != 'POST')) {
                warn_exit(do_lang_tempcode('IMPROPERLY_FILLED_IN'));
            }
        }

        if ($type == 'browse') {
            return $this->step1(); // welcome
        }
        if ($type == 'step2') {
            return $this->step2(); // information
        }
        if ($type == 'step3') {
            return $this->step3(); // config
        }
        if ($type == 'step4') {
            return $this->step4(); // addons
        }
        if ($type == 'step5') {
            return $this->step5(); // zone/feature configuration
        }
        if ($type == 'step6') {
            return $this->step6(); // block choice
        }
        if ($type == 'step7') {
            return $this->step7(); // rules
        }
        if ($type == 'step8') {
            return $this->step8(); // Theme Wizard
        }
        if ($type == 'step9') {
            return $this->step9(); // close-status
        }
        if ($type == 'step10') {
            return $this->step10(); // actualisation (redirects to step11 automatically)
        }
        if ($type == 'step11') {
            return $this->step11(); // do-next
        }
        if ($type == 'install_test_content') {
            return $this->install_test_content();
        }
        if ($type == 'uninstall_test_content') {
            return $this->uninstall_test_content();
        }

        return new Tempcode();
    }

    /**
     * UI for a setup wizard step (welcome).
     *
     * @return Tempcode The UI
     */
    public function step1()
    {
        $dh = @opendir(get_custom_file_base() . '/imports/addons/');
        $addons_available = array();
        if ($dh !== false) {
            while (($file = readdir($dh)) !== false) {
                if (substr($file, -4) == '.tar') {
                    $addons_available[] = basename($file, '.tar');
                }
            }
            closedir($dh);
        }
        foreach ($addons_available as $aa) {
            if (!addon_installed($aa)) {
                $addon_management = build_url(array('page' => 'admin_addons'), get_module_zone('admin_addons'));
                attach_message(do_lang_tempcode('ADDONS_NOT_INSTALLED_IN_SETUPWIZARD', escape_html($addon_management->evaluate())), 'notice');
                break;
            }
        }

        $_done_once = get_value('setupwizard_completed');
        $done_once = $_done_once !== null;

        $post_url = build_url(array('page' => '_SELF', 'type' => 'step2'), '_SELF', array('keep_theme_seed' => true, 'keep_theme_dark' => true, 'keep_theme_source' => true, 'keep_theme_algorithm' => true));
        $text = new Tempcode();
        $addons_url = build_url(array('page' => 'admin_addons'), get_module_zone('admin_addons'));
        $text->attach(paragraph(do_lang_tempcode($done_once ? 'SETUPWIZARD_1_DESCRIBE_ALT' : 'SETUPWIZARD_1_DESCRIBE', escape_html($addons_url->evaluate()))));
        $rescue_url = build_url(array('page' => '', 'keep_safe_mode' => '1'), '');
        $text->attach(paragraph(do_lang_tempcode('SETUPWIZARD_SAFE_MODE', escape_html($rescue_url->evaluate()), do_template('ICON', array('_GUID' => '049d21a64c40a98fc06229bb3985c85a', 'NAME' => 'tool_buttons/software_chat')))));
        $submit_name = do_lang_tempcode('START');

        $fields = new Tempcode();

        $inner = do_template('FORM', array(
            '_GUID' => '71316d91703e3549301f57182405c997',
            'SKIP_WEBSTANDARDS' => true,
            'FIELDS' => $fields,
            'URL' => $post_url,
            'TEXT' => $text,
            'SUBMIT_ICON' => 'buttons/proceed',
            'SUBMIT_NAME' => $submit_name,
            'HIDDEN' => '',
        ));
        return do_template('SETUPWIZARD_SCREEN', array(
                '_GUID' => '38a02343903542f8bbe1fb49a7b21eb7',
                'TITLE' => $this->title,
                'STEP' => strval($this->get_effective_step(1)),
                'INNER' => $inner,
                'NUM_STEPS_ENUMERABLE' => strval($this->get_num_steps_enumerable()),
            ));
    }

    /**
     * UI for a setup wizard step (information).
     *
     * @return Tempcode The UI
     */
    public function step2()
    {
        $post_url = build_url(array('page' => '_SELF', 'type' => 'step3'), '_SELF');
        $submit_name = do_lang_tempcode('PROCEED');
        $hidden = static_evaluate_tempcode(build_keep_post_fields());

        // Choice of install profile...

        $installprofiles = new Tempcode();
        $installprofiles->attach(form_input_list_entry('', true, do_lang_tempcode('NA_EM')));

        // Install-profiles of installed themes
        require_code('themes2');
        $themes = find_all_themes();
        foreach ($themes as $theme => $theme_title) {
            $hook = get_theme_option('setupwizard__install_profile', null, $theme);
            if ($hook != '') {
                $path = get_file_base() . '/sources_custom/hooks/modules/admin_setupwizard_installprofiles/' . filter_naughty_harsh($hook) . '.php';
                if (!file_exists($path)) {
                    $path = get_file_base() . '/sources/hooks/modules/admin_setupwizard_installprofiles/' . filter_naughty_harsh($hook) . '.php';
                }
                if (file_exists($path)) {
                    $_hook_bits = extract_module_functions($path, array('info'));
                    $installprofile = is_array($_hook_bits[0]) ? call_user_func_array($_hook_bits[0][0], $_hook_bits[0][1]) : cms_eval($_hook_bits[0], $path);
                    if ($installprofile !== null) {
                        $installprofiles->attach(form_input_list_entry($hook . '__' . $theme, get_param_string('id', '') == $hook . '__' . $theme, do_lang('INSTALLPROFILE_WITH_THEME', $installprofile['title'], $theme_title)));
                    }
                }
            }
        }

        // Pure install profiles
        $hooks = find_all_hooks('modules', 'admin_setupwizard_installprofiles');
        require_code('zones2');
        foreach (array_keys($hooks) as $hook) {
            $path = get_file_base() . '/sources_custom/hooks/modules/admin_setupwizard_installprofiles/' . filter_naughty_harsh($hook) . '.php';
            if (!file_exists($path)) {
                $path = get_file_base() . '/sources/hooks/modules/admin_setupwizard_installprofiles/' . filter_naughty_harsh($hook) . '.php';
            }
            $_hook_bits = extract_module_functions($path, array('info'));
            $installprofile = is_array($_hook_bits[0]) ? call_user_func_array($_hook_bits[0][0], $_hook_bits[0][1]) : cms_eval($_hook_bits[0], $path);
            if ($installprofile !== null) {
                $installprofiles->attach(form_input_list_entry($hook, get_param_string('id', '') == $hook, $installprofile['title']));
            }
        }

        $fields = new Tempcode();
        $fields->attach(form_input_huge_list(do_lang_tempcode('INSTALLPROFILE'), do_lang_tempcode('DESCRIPTION_INSTALLPROFILE'), 'installprofile', $installprofiles, null, true, false));

        // --

        $text = do_template('SETUPWIZARD_2', array(
            '_GUID' => '2042f3786d10c7c5be5d38ea28942b47',
            'SKIP_WEBSTANDARDS' => true,
            'URL' => $post_url,
            'SUBMIT_ICON' => 'buttons/proceed',
            'SUBMIT_NAME' => $submit_name,
        ));

        $inner = do_template('FORM', array(
            '_GUID' => '185da65845b3001cc152b15845b63b89',
            'SKIP_WEBSTANDARDS' => true,
            'SKIP_REQUIRED' => true,
            'FIELDS' => $fields,
            'URL' => $post_url,
            'TEXT' => $text,
            'SUBMIT_ICON' => 'buttons/proceed',
            'SUBMIT_NAME' => $submit_name,
            'HIDDEN' => $hidden,
        ));

        return do_template('SETUPWIZARD_SCREEN', array(
            '_GUID' => 'e04bc40dfc4047b62b586711d15ad875',
            'TITLE' => $this->title,
            'STEP' => strval($this->get_effective_step(2)),
            'INNER' => $inner,
            'NUM_STEPS_ENUMERABLE' => strval($this->get_num_steps_enumerable()),
        ));
    }

    /**
     * UI for a setup wizard step (config).
     *
     * @return Tempcode The UI
     */
    public function step3()
    {
        $post_url = build_url(array('page' => '_SELF', 'type' => 'step4'), '_SELF');
        $text = do_lang_tempcode('SETUPWIZARD_3_DESCRIBE');
        $submit_name = do_lang_tempcode('PROCEED');

        $fields = new Tempcode();
        $hidden = static_evaluate_tempcode(build_keep_post_fields(array('installprofile')));

        $installprofile = post_param_string('installprofile', '');
        if (strpos($installprofile, '__') !== false) {
            list($installprofile, $theme) = explode('__', $installprofile);
            $hidden .= static_evaluate_tempcode(form_input_hidden('source_theme', $theme));
        } else {
            $hidden .= static_evaluate_tempcode(form_input_hidden('source_theme', 'default'));
        }
        $hidden .= static_evaluate_tempcode(form_input_hidden('installprofile', $installprofile));

        require_lang('zones');

        $site_name = get_option('site_name');
        $description = get_option('description');
        $site_scope = get_option('site_scope');
        $_header_text = $GLOBALS['SITE_DB']->query_select_value('zones', 'zone_header_text', array('zone_name' => ''));
        $header_text = get_translated_text($_header_text);
        $copyright = get_option('copyright');
        $staff_address = get_option('staff_address');
        $keywords = get_option('keywords');
        $google_analytics = get_option('google_analytics');
        $timezone = get_site_timezone();

        if ($site_name == '???') {
            $site_name = do_lang('EXAMPLE_SITE_NAME');
        }
        if ($description == '???') {
            $description = do_lang('EXAMPLE_DESCRIPTION');
        }
        if ($site_scope == '???') {
            $site_scope = do_lang('EXAMPLE_SITE_SCOPE');
        }
        if ($header_text == 'A site about ???') {
            $header_text = do_lang('EXAMPLE_HEADER_TEXT');
        }
        if ($copyright == 'Copyright &copy;, ???, 2006') {
            $copyright = do_lang('EXAMPLE_COPYRIGHT');
        }
        if ($keywords == '') {
            $keywords = do_lang('EXAMPLE_KEYWORDS');
        }

        $fields->attach(form_input_line(do_lang_tempcode('SITE_NAME'), do_lang_tempcode('CONFIG_OPTION_site_name'), 'site_name', $site_name, true));

        $fields->attach(form_input_line(do_lang_tempcode('DESCRIPTION'), do_lang_tempcode('CONFIG_OPTION_description'), 'description', $description, false));

        $fields->attach(form_input_line(do_lang_tempcode('SITE_SCOPE'), do_lang_tempcode('CONFIG_OPTION_site_scope'), 'site_scope', $site_scope, true));

        $fields->attach(form_input_line(do_lang_tempcode('HEADER_TEXT'), do_lang_tempcode('DESCRIPTION_HEADER_TEXT'), 'header_text', $header_text, false));

        $fields->attach(form_input_line(do_lang_tempcode('COPYRIGHT'), do_lang_tempcode('CONFIG_OPTION_copyright'), 'copyright', $copyright, false));

        $fields->attach(form_input_line(do_lang_tempcode('STAFF_EMAIL'), do_lang_tempcode('CONFIG_OPTION_staff_address'), 'staff_address', $staff_address, true));

        $fields->attach(form_input_line(do_lang_tempcode('KEYWORDS'), do_lang_tempcode('CONFIG_OPTION_keywords'), 'keywords', $keywords, false));

        $timezone_list = '';
        foreach (get_timezone_list() as $_timezone => $timezone_nice) {
            $timezone_list .= static_evaluate_tempcode(form_input_list_entry($_timezone, $_timezone == $timezone, $timezone_nice));
        }
        $fields->attach(form_input_list(do_lang_tempcode('TIMEZONE'), do_lang_tempcode('CONFIG_OPTION_timezone'), 'timezone', make_string_tempcode($timezone_list)));

        $fields->attach(form_input_line(do_lang_tempcode('GOOGLE_ANALYTICS'), do_lang_tempcode('CONFIG_OPTION_google_analytics'), 'google_analytics', $google_analytics, false));

        $fixed_width = get_theme_option('fixed_width', null, post_param_string('source_theme', 'default'));
        if (get_theme_option('setupwizard__lock_fixed_width_choice', null, post_param_string('source_theme', 'default')) == '1') {
            $fields->attach(form_input_tick(do_lang_tempcode('FIXED_WIDTH'), do_lang_tempcode('CONFIG_OPTION_fixed_width'), 'fixed_width', $fixed_width == '1'));
        } else {
            $hidden .= static_evaluate_tempcode(form_input_hidden('fixed_width', $fixed_width));
        }

        if (get_theme_option('setupwizard__provide_cms_advert_choice', null, post_param_string('source_theme', 'default')) == '1') {
            $panel_path = get_custom_file_base() . '/pages/comcode_custom/' . get_site_default_lang() . '/panel_left.txt';
            if (file_exists($panel_path)) {
                $include_cms_advert = strpos(file_get_contents($panel_path), 'logos/') !== false;
            } else {
                $include_cms_advert = false;
            }
            $fields->attach(form_input_tick(do_lang_tempcode('INCLUDE_CMS_ADVERT'), do_lang_tempcode('DESCRIPTION_INCLUDE_CMS_ADVERT'), 'include_cms_advert', $include_cms_advert));
        } else {
            $hidden .= static_evaluate_tempcode(form_input_hidden('include_cms_advert', '0'));
        }

        switch (get_option('minimum_password_length')) {
            case '8':
                $security_level = 'high';
                break;
            case '5':
                $security_level = 'low';
                break;
            case '6':
            default:
                $security_level = 'medium';
                break;
        }
        $security_levels = new Tempcode();
        foreach (array('low', 'medium', 'high') as $_security_level) {
            $security_levels->attach(form_input_list_entry($_security_level, $_security_level == $security_level, do_lang_tempcode('SECURITY_LEVEL_' . $_security_level)));
        }
        $fields->attach(form_input_list(do_lang_tempcode('SECURITY_LEVEL'), do_lang_tempcode('DESCRIPTION_SECURITY_LEVEL'), 'security_level', $security_levels));

        $inner = do_template('FORM', array(
            '_GUID' => '3126441524b51cba6a1e0de336c8a9d5',
            'SKIP_WEBSTANDARDS' => true,
            'SKIPPABLE' => 'skip_3',
            'FIELDS' => $fields,
            'URL' => $post_url,
            'TEXT' => $text,
            'SUBMIT_ICON' => 'buttons/proceed',
            'SUBMIT_NAME' => $submit_name,
            'HIDDEN' => '',
        ));
        return do_template('SETUPWIZARD_SCREEN', array(
                '_GUID' => '6bdae2f0aa24b5dbe81fd0fc72e87feb',
                'TITLE' => $this->title,
                'STEP' => strval($this->get_effective_step(3)),
                'INNER' => $inner,
                'NUM_STEPS_ENUMERABLE' => strval($this->get_num_steps_enumerable()),
            ));
    }

    /**
     * UI for a setup wizard step (addons).
     *
     * @return Tempcode The UI
     */
    public function step4()
    {
        require_code('addons2');
        require_lang('addons');

        $post_url = build_url(array('page' => '_SELF', 'type' => 'step5'), '_SELF');
        $text = do_lang_tempcode('SETUPWIZARD_4_DESCRIBE');
        $submit_name = do_lang_tempcode('PROCEED');
        $hidden = static_evaluate_tempcode(build_keep_post_fields());

        $addons_installed = find_installed_addons();
        $addons_not_installed = list_to_map('name', find_available_addons(false, false));

        $fields = '';
        $fields_advanced = '';

        $installprofile = post_param_string('installprofile', '');
        $addon_list_override_to_off_by_default = array();
        if ($installprofile != '') {
            require_code('hooks/modules/admin_setupwizard_installprofiles/' . filter_naughty_harsh($installprofile));
            $object = object_factory('Hook_admin_setupwizard_installprofiles_' . filter_naughty_harsh($installprofile));
            $profile_addons = $object->get_addon_list();
            list($addon_list_on_by_default, $addon_list_advanced_on_by_default) = $profile_addons;
            if (array_key_exists(2, $profile_addons)) {
                $addon_list_override_to_off_by_default = $profile_addons[2];
            }
        } else {
            $addon_list_on_by_default = null;
            $addon_list_advanced_on_by_default = array();
        }

        /*$addon_list_on_by_default = array(   These will be put on in individual Setup Wizard profiles; we list them here just so our addon_setupwizard automated test can ensure we haven't forgotten to consider their status
            'aggregate_types',
            'authors',
            'calendar',
            'chat',
            'content_privacy',
            'content_reviews',
            'debrand',
            'downloads',
            'forum_blocks',
            'galleries',
            'match_key_permissions',
            'news',
            'newsletter',
            'cns_clubs',
            'cns_contact_member',
            'cns_forum',
            'cns_member_photos',
            'cns_member_titles',
            'cns_multi_moderations',
            'cns_post_templates',
            'cns_signatures',
            'cns_warnings',
            'points',
            'polls',
            'quizzes',
            'random_quotes',
            'realtime_rain',
            'recommend',
            'shopping',
            'ssl',
            'welcome_emails',
            'wiki',
            'zone_logos',
        );*/

        // These are on by default regardless of install profile. It's useful, because we don't want install profiles to have to be too prescriptive, and we want old ones to keep working well even if new addons have been introduced.
        if ($addon_list_on_by_default !== null) {
            $addon_list_on_by_default = array_merge($addon_list_on_by_default, array(
                'banners',
                'ecommerce',
                'cns_avatars',
                'cns_cartoon_avatars',
                'cns_member_avatars',
                'cns_thematic_avatars',
                'wordfilter',
            ));
        }
        $addon_list_advanced_on_by_default = array_merge($addon_list_advanced_on_by_default, array(
            'actionlog',
            'all_icons',
            'awards',
            'breadcrumbs',
            'captcha',
            'catalogues',
            'counting_blocks',
            'custom_comcode',
            'errorlog',
            'health_check',
            'help_page',
            'import',
            'language_block',
            'commandr',
            'cns_cpfs',
            'page_management',
            'redirects_editor',
            'search',
            'securitylogging',
            'setupwizard',
            'tickets',
            'stats',
            'stats_block',
            'syndication',
            'syndication_blocks',
            'themewizard',
            'uninstaller',
            'unvalidated',
            'phpinfo',
            'apache_config_files',
            'code_editor',
            'linux_helper_scripts',
            'windows_helper_scripts',
            'weather',
            'xml_fields',
            'users_online_block',
            'news_shared',
            'filedump',
            'filebased_persistent_caching',
            'robots_txt',
            'getid3', // this will be downloaded as it is not bundled, for licensing reasons
        ));
        // ... unless the install profile really is shunning them
        foreach ($addon_list_override_to_off_by_default as $_to_find) {
            if ($addon_list_on_by_default !== null) {
                $_found = array_search($_to_find, $addon_list_on_by_default);
                if ($_found !== false) {
                    unset($addon_list_on_by_default[$_found]);
                }
            }
            $_found = array_search($_to_find, $addon_list_advanced_on_by_default);
            if ($_found !== false) {
                unset($addon_list_advanced_on_by_default[$_found]);
            }
        }

        $addon_list_advanced_off_by_default = array(
            // Hint that these must go under advanced (as they default as visible). Note that presence of an addon in an 'on' list gives it precedence.
            'installer',
            'rootkit_detector',
            'failover',
            'msn',
            'backup',
            'ldap',
            'sms',
            'printer_friendly_block',
            'data_mappr', // this will be downloaded as it is not bundled
            'user_mappr', // this will be downloaded as it is not bundled
            'facebook_support', // this will be downloaded as it is not bundled
            'twitter_support', // this will be downloaded as it is not bundled
        );
        if (GOOGLE_APPENGINE) {
            $addon_list_advanced_off_by_default[] = 'google_appengine';
        }

        // Do we need to download any from compo.sr?
        $GLOBALS['DEV_MODE'] = false;
        foreach (array_merge(($addon_list_on_by_default === null) ? array() : $addon_list_on_by_default, $addon_list_advanced_on_by_default, $addon_list_advanced_off_by_default) as $mentioned_addon) {
            if ((!array_key_exists($mentioned_addon, $addons_installed)) && (!array_key_exists($mentioned_addon, $addons_not_installed))) {
                $remote_addons = find_remote_addons();
                $_mentioned_addon = titleify($mentioned_addon);
                if (array_key_exists($_mentioned_addon, $remote_addons)) {
                    $id = $remote_addons[$_mentioned_addon];
                    require_code('uploads');
                    $_POST['url'] = 'https://compo.sr/site/dload.php?id=' . strval($id);
                    get_url('url', 'file', 'imports/addons', 0, CMS_UPLOAD_ANYTHING, false, '', '', true); // Download it
                }
            }
        }
        $addons_not_installed = list_to_map('name', find_available_addons(false, false, list_to_map('file', $addons_not_installed))); // Re-search for these, as more may have been downloaded above

        $all_addons = $addons_installed + $addons_not_installed;
        foreach ($all_addons as $addon_name => $row) {
            if (!isset($all_addons[$addon_name]['name'])) {
                $all_addons[$addon_name]['name'] = titleify($addon_name);
            }
        }
        sort_maps_by($all_addons, 'name', false, true);
        $_lock_addons_on = get_theme_option('setupwizard__lock_addons_on', null, post_param_string('source_theme', 'default'));
        $lock_addons_on = ($_lock_addons_on == '') ? array() : explode(',', $_lock_addons_on);
        require_code('addons');
        foreach ($all_addons as $addon_name => $row) {
            $is_core = ($addon_name == 'core') || (substr($addon_name, 0, 5) == 'core_') || (in_array($addon_name, $lock_addons_on));
            if ((!$is_core) && (substr($addon_name, -7) != '_shared') && ($addon_name != 'setupwizard')) {
                $is_advanced_on_by_default = in_array($addon_name, $addon_list_advanced_on_by_default);
                $is_advanced_off_by_default = in_array($addon_name, $addon_list_advanced_off_by_default);
                $install_by_default = (($addon_list_on_by_default !== null) && (in_array($addon_name, $addon_list_on_by_default)) || ($is_advanced_on_by_default) || (($addon_list_on_by_default === null) && (!$is_advanced_off_by_default)));

                $addon_description = $row['description'];
                if ((substr($addon_description, -1) != '.') && ($addon_description != '')) {
                    $addon_description .= '.';
                }
                $_addon_description = protect_from_escaping(symbol_truncator(array(static_evaluate_tempcode(comcode_to_tempcode($addon_description)), '1000', '0', '1'), 'left'));

                $addon_icon = find_addon_icon($addon_name, false, array_key_exists('tar_path', $row) ? $row['tar_path'] : null);
                $addon_name_pretty = protect_from_escaping(do_template('ADDON_NAME', array('_GUID' => 'c036db4d27417f79e1f395d1edb44020', 'IMAGE_URL' => $addon_icon, 'NAME' => $row['name'])));

                $field = form_input_tick($addon_name_pretty, $_addon_description, 'addon_' . $addon_name, $install_by_default);

                $advanced = ($is_advanced_on_by_default) || ($is_advanced_off_by_default);
                if ($advanced) {
                    $fields_advanced .= $field->evaluate();
                } else {
                    $fields .= $field->evaluate();
                }
            } elseif (!$is_core) {
                $hidden .= static_evaluate_tempcode(form_input_hidden('addon_' . $addon_name, '1'));
            }
        }

        $fields .= static_evaluate_tempcode(do_template('FORM_SCREEN_FIELD_SPACER', array('_GUID' => '00948cc876d0ecb8b511800eabd8cae2', 'SECTION_HIDDEN' => true, 'TITLE' => do_lang_tempcode('ADVANCED'))));
        $fields .= $fields_advanced;

        $inner = do_template('FORM', array(
            '_GUID' => '0f361a3ac0e020ba71f3a7a900eca0e4',
            'NO_SIZING' => true,
            'SKIP_WEBSTANDARDS' => true,
            'SKIPPABLE' => 'skip_4',
            'FIELDS' => $fields,
            'URL' => $post_url,
            'TEXT' => $text,
            'SUBMIT_ICON' => 'buttons/proceed',
            'SUBMIT_NAME' => $submit_name,
            'HIDDEN' => $hidden,
        ));
        return do_template('SETUPWIZARD_SCREEN', array(
                '_GUID' => 'ca91a76aa418d5c9ae956247ebc70652',
                'TITLE' => $this->title,
                'STEP' => strval($this->get_effective_step(4)),
                'INNER' => $inner,
                'NUM_STEPS_ENUMERABLE' => strval($this->get_num_steps_enumerable()),
            ));
    }

    /**
     * UI for a setup wizard step (zone/feature configuration).
     *
     * @return Tempcode The UI
     */
    public function step5()
    {
        require_lang('menus');

        $post_url = build_url(array('page' => '_SELF', 'type' => $this->has_block_step() ? 'step6' : 'step7'), '_SELF');
        $text = do_lang_tempcode('SETUPWIZARD_5_DESCRIBE');
        $submit_name = do_lang_tempcode('PROCEED');
        $hidden = static_evaluate_tempcode(build_keep_post_fields());

        $fields = '';

        $installprofile = post_param_string('installprofile', '');
        if ($installprofile != '') {
            $path = get_file_base() . '/sources_custom/hooks/modules/admin_setupwizard_installprofiles/' . filter_naughty_harsh($installprofile) . '.php';
            if (!file_exists($path)) {
                $path = get_file_base() . '/sources/hooks/modules/admin_setupwizard_installprofiles/' . filter_naughty_harsh($installprofile) . '.php';
            }
            $_hook_bits = extract_module_functions($path, array('field_defaults'));
            $field_defaults = is_array($_hook_bits[0]) ? call_user_func_array($_hook_bits[0][0], $_hook_bits[0][1]) : cms_eval($_hook_bits[0], $path);
        } else {
            $field_defaults = array();
        }

        $fields .= static_evaluate_tempcode(do_template('FORM_SCREEN_FIELD_SPACER', array('_GUID' => '9f81456d95f2ff66a46e2a5b9901aaf3', 'TITLE' => do_lang_tempcode('FEATURES'))));

        $hooks = find_all_hooks('modules', 'admin_setupwizard');
        foreach (array_keys($hooks) as $hook) {
            if ((post_param_integer('addon_' . $hook, 0) == 1) && ($hook != 'core')) {
                $path = get_file_base() . '/sources_custom/hooks/modules/admin_setupwizard/' . filter_naughty_harsh($hook) . '.php';
                if (!file_exists($path)) {
                    $path = get_file_base() . '/sources/hooks/modules/admin_setupwizard/' . filter_naughty_harsh($hook) . '.php';
                }
                if (strpos(file_get_contents($path), 'get_fields') !== false) { // Memory optimisation
                    require_code('hooks/modules/admin_setupwizard/' . filter_naughty_harsh($hook));
                    $hook = object_factory('Hook_sw_' . filter_naughty_harsh($hook), true);
                    if ($hook === null) {
                        continue;
                    }
                    if (method_exists($hook, 'get_fields')) {
                        list($hook_fields, $hook_hidden) = $hook->get_fields($field_defaults);
                        $hidden .= $hook_hidden->evaluate();
                        $fields .= static_evaluate_tempcode($hook_fields);
                    }
                }
            }
        }
        require_code('hooks/modules/admin_setupwizard/core'); // Core one explicitly goes last
        $hook = object_factory('Hook_sw_core', true);
        if (method_exists($hook, 'get_fields')) {
            list($hook_fields, $hook_hidden) = $hook->get_fields($field_defaults);
            $hidden .= $hook_hidden->evaluate();
            $fields .= static_evaluate_tempcode($hook_fields);
        }

        $fields .= static_evaluate_tempcode(form_input_tick(do_lang_tempcode('INSTALL_TEST_CONTENT'), do_lang_tempcode('DESCRIPTION_INSTALL_TEST_CONTENT'), 'install_test_content', true));

        require_code('setupwizard');
        require_javascript('setupwizard');
        $inner = do_template('FORM', array(
            '_GUID' => 'f1e9a4d271c7d68ff9da6dc0438f6e3f',
            'SKIP_WEBSTANDARDS' => true,
            'JS_FUNCTION_CALLS' => array('adminSetupWizardStep5'),
            'SKIPPABLE' => 'skip_5',
            'FIELDS' => $fields,
            'URL' => $post_url,
            'TEXT' => $text,
            'SUBMIT_ICON' => 'buttons/proceed',
            'SUBMIT_NAME' => $submit_name,
            'HIDDEN' => $hidden,
        ));
        return do_template('SETUPWIZARD_SCREEN', array(
                '_GUID' => '8dfd885199d3d1416c044fad7a97d953',
                'TITLE' => $this->title,
                'STEP' => strval($this->get_effective_step(5)),
                'INNER' => $inner,
                'NUM_STEPS_ENUMERABLE' => strval($this->get_num_steps_enumerable()),
            ));
    }

    /**
     * UI for a setup wizard step (block choice).
     *
     * @return Tempcode The UI
     */
    public function step6()
    {
        require_all_lang();

        $installprofile = post_param_string('installprofile', '');
        if ($installprofile != '') {
            require_code('hooks/modules/admin_setupwizard_installprofiles/' . filter_naughty_harsh($installprofile));
            $object = object_factory('Hook_admin_setupwizard_installprofiles_' . filter_naughty_harsh($installprofile));
            $default_blocks = $object->default_blocks();
        } else {
            $default_blocks = null;
        }

        $main_blocks = array();
        $side_blocks = array();
        $hooks = find_all_hook_obs('modules', 'admin_setupwizard', 'Hook_sw_');
        foreach ($hooks as $hook => $ob) {
            if (post_param_integer('addon_' . $hook, 0) == 1) {
                if (method_exists($ob, 'get_blocks')) {
                    $ret = $ob->get_blocks();
                    if (count($ret) != 0) {
                        list($a, $b) = $ret;
                        $main_blocks = array_merge($main_blocks, $a);
                        $side_blocks = array_merge($side_blocks, $b);
                    }
                }
            }
        }
        ksort($main_blocks);
        ksort($side_blocks);

        if (count($main_blocks) == 0 && count($side_blocks) == 0) {
            return $this->step7();
        }

        $post_url = build_url(array('page' => '_SELF', 'type' => 'step7'), '_SELF');
        $text = do_lang_tempcode('SETUPWIZARD_6_DESCRIBE');
        $submit_name = do_lang_tempcode('PROCEED');

        $fields = '';
        $hidden = static_evaluate_tempcode(build_keep_post_fields());

        require_lang('blocks');
        require_lang('zones');
        require_code('zones2');

        if (count($main_blocks) > 0) {
            $tmp = do_template('FORM_SCREEN_FIELD_SPACER', array('_GUID' => 'dfc20251e4f6b37ec1e046d0903250aa', 'TITLE' => do_lang_tempcode('HOME')));
            $fields .= $tmp->evaluate(); /*XHTMLXHTML*/
            foreach ($main_blocks as $block => $position_bits) {
                if (!file_exists(get_file_base() . '/sources/blocks/' . $block . '.php')) {
                    continue;
                }

                $description = paragraph(do_lang_tempcode('BLOCK_' . $block . '_DESCRIPTION'));
                $description->attach(paragraph(do_lang_tempcode('BLOCK_' . $block . '_USE')));
                $block_nice = cleanup_block_name($block);
                if ($default_blocks === null) {
                    $position = $position_bits[1];
                } else {
                    $position = 'NO';
                    foreach (array('YES', 'YES_CELL', 'PANEL_LEFT', 'PANEL_RIGHT') as $p) {
                        if (in_array($block, $default_blocks[$p])) {
                            $position = $p;
                        }
                    }
                }
                $main_list = new Tempcode();
                $main_list->attach(form_input_list_entry('NO', $position == 'NO', do_lang_tempcode('BLOCK_CONFIGURATION__PANEL_NO')));
                $main_list->attach(form_input_list_entry('YES', $position == 'YES', do_lang_tempcode('BLOCK_CONFIGURATION__PANEL_YES')));
                $main_list->attach(form_input_list_entry('YES_CELL', $position == 'YES_CELL', do_lang_tempcode('BLOCK_CONFIGURATION__PANEL_YES_CELL')));
                $main_list->attach(form_input_list_entry('PANEL_LEFT', $position == 'PANEL_LEFT', do_lang_tempcode('BLOCK_CONFIGURATION__PANEL_LEFT')));
                $main_list->attach(form_input_list_entry('PANEL_RIGHT', $position == 'PANEL_RIGHT', do_lang_tempcode('BLOCK_CONFIGURATION__PANEL_RIGHT')));
                $tmp = form_input_list($block_nice, $description, 'block_SITE_' . $block, $main_list);
                $fields .= $tmp->evaluate(); /*XHTMLXHTML*/
            }
        }

        if (count($side_blocks) > 0) {
            $tmp = do_template('FORM_SCREEN_FIELD_SPACER', array('_GUID' => '13e0d3002669654d9b45b4739ecbf28c', 'TITLE' => do_lang_tempcode('PANELS')));
            $fields .= $tmp->evaluate(); /*XHTMLXHTML*/
            foreach ($side_blocks as $block => $position_bits) {
                if (!file_exists(get_file_base() . '/sources/blocks/' . $block . '.php')) {
                    continue;
                }

                $description = paragraph(do_lang_tempcode('BLOCK_' . $block . '_DESCRIPTION'));
                $description->attach(paragraph(do_lang_tempcode('BLOCK_' . $block . '_USE')));
                $block_nice = cleanup_block_name($block);
                if ($default_blocks === null) {
                    $position = $position_bits[1];
                } else {
                    $position = 'NO';
                    foreach (array('YES', 'YES_CELL', 'PANEL_LEFT', 'PANEL_RIGHT') as $p) {
                        if (in_array($block, $default_blocks[$p])) {
                            $position = $p;
                        }
                    }
                }
                $side_list = new Tempcode();
                $side_list->attach(form_input_list_entry('PANEL_NONE', $position == 'PANEL_NONE', do_lang_tempcode('BLOCK_CONFIGURATION__PANEL_NONE')));
                $side_list->attach(form_input_list_entry('PANEL_LEFT', $position == 'PANEL_LEFT', do_lang_tempcode('BLOCK_CONFIGURATION__PANEL_LEFT')));
                $side_list->attach(form_input_list_entry('PANEL_RIGHT', $position == 'PANEL_RIGHT', do_lang_tempcode('BLOCK_CONFIGURATION__PANEL_RIGHT')));
                $tmp = form_input_list($block_nice, $description, 'block_SITE_' . $block, $side_list);
                $fields .= $tmp->evaluate(); /*XHTMLXHTML*/
            }
        }

        $inner = do_template('FORM', array(
            '_GUID' => 'd463906b9e2cd8c37577d64783aa844c',
            'SKIP_WEBSTANDARDS' => true,
            'SKIPPABLE' => 'skip_6',
            'FIELDS' => $fields,
            'URL' => $post_url,
            'TEXT' => $text,
            'PREVIEW' => true,
            'SUBMIT_ICON' => 'buttons/proceed',
            'SUBMIT_NAME' => $submit_name,
            'HIDDEN' => $hidden,
        ));
        return do_template('SETUPWIZARD_SCREEN', array(
                '_GUID' => '7c2cbc9577974b210e196b92158b4bb8',
                'TITLE' => $this->title,
                'STEP' => strval($this->get_effective_step(6)),
                'INNER' => $inner,
                'NUM_STEPS_ENUMERABLE' => strval($this->get_num_steps_enumerable()),
            ));
    }

    /**
     * Get Comcode to save as the rules.
     *
     * @param  ID_TEXT $code A code relating to which rules set to get
     * @return string The Comcode
     */
    protected function get_rules_file($code)
    {
        require_code('zones3');
        return get_template_contents('rules_' . $code);
    }

    /**
     * UI for a setup wizard step (rules).
     *
     * @return Tempcode The UI
     */
    public function step7()
    {
        $post_url = build_url(array('page' => '_SELF', 'type' => $this->has_themewizard_step() ? 'step8' : 'step9'), '_SELF');
        $text = do_lang_tempcode('SETUPWIZARD_7_DESCRIBE');
        $submit_name = do_lang_tempcode('PROCEED');
        $hidden = static_evaluate_tempcode(build_keep_post_fields());

        $installprofile = post_param_string('installprofile', '');
        if ($installprofile != '') {
            require_code('hooks/modules/admin_setupwizard_installprofiles/' . filter_naughty_harsh($installprofile));
            $object = object_factory('Hook_admin_setupwizard_installprofiles_' . filter_naughty_harsh($installprofile));
            $field_defaults = $object->field_defaults();
        } else {
            $field_defaults = array();
        }

        $list = new Tempcode();
        $list->attach(form_input_list_entry('balanced', array_key_exists('rules', $field_defaults) ? ($field_defaults['rules'] == 'balanced') : true, do_lang_tempcode('SETUPWIZARD_RULES_balanced')));
        $list->attach(form_input_list_entry('liberal', array_key_exists('rules', $field_defaults) ? ($field_defaults['rules'] == 'liberal') : false, do_lang_tempcode('SETUPWIZARD_RULES_liberal')));
        $list->attach(form_input_list_entry('corporate', array_key_exists('rules', $field_defaults) ? ($field_defaults['rules'] == 'corporate') : false, do_lang_tempcode('SETUPWIZARD_RULES_corporate')));
        $fields = form_input_list(do_lang_tempcode('RULES'), do_lang_tempcode('DESCRIPTION_RULES'), 'rules', $list, null, true);

        require_code('setupwizard');
        require_javascript('setupwizard');
        $js_function_calls = array('adminSetupWizardStep7');
        $form = do_template('FORM', array(
            '_GUID' => 'bf01a2b90967e86213ae0672c36a4b4e',
            'SKIPPABLE' => 'skip_7',
            'FIELDS' => $fields,
            'URL' => $post_url,
            'TEXT' => $text,
            'SUBMIT_ICON' => 'buttons/proceed',
            'SUBMIT_NAME' => $submit_name,
            'HIDDEN' => $hidden,
            'JS_FUNCTION_CALLS' => $js_function_calls,
        ));

        $balanced = comcode_to_tempcode($this->get_rules_file('balanced'), null, true);
        $liberal = comcode_to_tempcode($this->get_rules_file('liberal'), null, true);
        $corporate = comcode_to_tempcode($this->get_rules_file('corporate'), null, true);

        $inner = do_template('SETUPWIZARD_7', array('_GUID' => '5e46c3a989e42fa6eec5a017e8c644c2', 'FORM' => $form, 'BALANCED' => $balanced, 'LIBERAL' => $liberal, 'CORPORATE' => $corporate));
        return do_template('SETUPWIZARD_SCREEN', array(
            '_GUID' => '04f24f8c44267d2ad315aa34243e9712',
            'TITLE' => $this->title,
            'STEP' => strval($this->get_effective_step(7)),
            'INNER' => $inner,
            'NUM_STEPS_ENUMERABLE' => strval($this->get_num_steps_enumerable()),
        ));
    }

    /**
     * UI for a setup wizard step (Theme Wizard).
     *
     * @return Tempcode The UI
     */
    public function step8()
    {
        require_lang('themes');
        require_code('themewizard');

        $post_url = build_url(array('page' => '_SELF', 'type' => 'step9'), '_SELF');
        $text = do_lang_tempcode('SETUPWIZARD_8_DESCRIBE');
        $submit_name = do_lang_tempcode('PROCEED');
        $hidden = static_evaluate_tempcode(build_keep_post_fields());

        $fields = new Tempcode();
        $fields->attach(form_input_colour(do_lang_tempcode('SEED_COLOUR'), do_lang_tempcode('DESCRIPTION_SEED_COLOUR'), 'seed_hex', '#' . find_theme_seed('default'), true));
        $fields->attach(form_input_tick(do_lang_tempcode('DARK_THEME'), do_lang_tempcode('DESCRIPTION_DARK_THEME'), 'dark', get_param_integer('dark', 0) == 1));

        $inner = do_template('FORM', array(
            '_GUID' => '7ef31eb9712cff98da57a92fc173f7af',
            'PREVIEW' => true,
            'SKIP_WEBSTANDARDS' => true,
            'SKIPPABLE' => 'skip_8',
            'FIELDS' => $fields,
            'URL' => $post_url,
            'TEXT' => $text,
            'SUBMIT_ICON' => 'buttons/proceed',
            'SUBMIT_NAME' => $submit_name,
            'HIDDEN' => $hidden,
        ));
        return do_template('SETUPWIZARD_SCREEN', array(
                '_GUID' => 'e67abf478cea7aed5cda64189549677a',
                'TITLE' => $this->title,
                'STEP' => strval($this->get_effective_step(8)),
                'INNER' => $inner,
                'NUM_STEPS_ENUMERABLE' => strval($this->get_num_steps_enumerable()),
            ));
    }

    /**
     * UI for a setup wizard step (close-status).
     *
     * @return Tempcode The UI
     */
    public function step9()
    {
        $post_url = build_url(array('page' => '_SELF', 'type' => 'step10'), '_SELF');
        $text = do_lang_tempcode('SETUPWIZARD_9_DESCRIBE');
        $submit_name = do_lang_tempcode('PROCEED');
        $hidden = static_evaluate_tempcode(build_keep_post_fields());

        $fields = new Tempcode();
        $fields->attach(form_input_tick(do_lang_tempcode('CLOSED_SITE'), do_lang_tempcode('CONFIG_OPTION_site_closed'), 'site_closed', true));
        $fields->attach(form_input_text(do_lang_tempcode('MESSAGE'), do_lang_tempcode('CONFIG_OPTION_closed'), 'closed', get_option('closed'), false));

        require_code('setupwizard');
        require_javascript('setupwizard');
        $js_function_calls = array('adminSetupWizardStep9');
        $inner = do_template('FORM', array(
            '_GUID' => 'c405a64a08328f78ac0e3f22a8365411',
            'SKIP_WEBSTANDARDS' => true,
            'SKIPPABLE' => 'skip_9',
            'FIELDS' => $fields,
            'URL' => $post_url,
            'TEXT' => $text,
            'SUBMIT_ICON' => 'buttons/proceed',
            'SUBMIT_NAME' => $submit_name,
            'HIDDEN' => $hidden,
            'JS_FUNCTION_CALLS' => $js_function_calls,
        ));
        return do_template('SETUPWIZARD_SCREEN', array(
                '_GUID' => 'de13f131460e7f342c8beb6ba5ae3f42',
                'TITLE' => $this->title,
                'STEP' => strval($this->get_effective_step(9)),
                'INNER' => $inner,
                'NUM_STEPS_ENUMERABLE' => strval($this->get_num_steps_enumerable()),
            ));
    }

    /**
     * UI for a setup wizard step (actualisation).
     *
     * @return Tempcode The UI
     */
    public function step10()
    {
        push_query_limiting(false);

        require_code('abstract_file_manager');
        force_have_afm_details();

        // Proceed...

        set_mass_import_mode();

        require_code('config2');
        require_code('themes2');
        require_code('themes3');
        require_lang('zones');
        require_code('files');
        require_code('images');

        $header_text = post_param_string('header_text');
        $name = post_param_string('site_name');
        require_code('fonts');
        $font = post_param_string('font', find_default_font());
        $installprofile = post_param_string('installprofile', '');
        $source_theme = post_param_string('source_theme', '');

        $default_logos = get_all_image_ids_type('logo/default_logos');
        shuffle($default_logos);
        $default_backgrounds = get_all_image_ids_type('logo/default_backgrounds');
        shuffle($default_backgrounds);
        $logo_theme_image = post_param_string('logo_theme_image', array_shift($default_logos));
        $background_theme_image = post_param_string('background_theme_image', array_shift($default_backgrounds));

        if ($installprofile != '') {
            // Run any specific code for the profile
            $object = null;
            if ((is_file(get_file_base() . '/sources/hooks/modules/admin_setupwizard_installprofiles/' . $installprofile . '.php')) || (is_file(get_file_base() . '/sources_custom/hooks/modules/admin_setupwizard_installprofiles/' . $installprofile . '.php'))) {
                require_code('hooks/modules/admin_setupwizard_installprofiles/' . filter_naughty_harsh($installprofile));
                $object = object_factory('Hook_admin_setupwizard_installprofiles_' . filter_naughty_harsh($installprofile), true);
            }
            if ($object !== null) {
                $object->install_code();
                $installprofileblocks = $object->default_blocks();
            } else { // Hmm, we probably just uninstalled the install-profile hook as its addon was not chosen! Whoopsie, but do our best.
                $installprofileblocks = array();
            }
        } else {
            $installprofileblocks = array();
        }

        $doing_themewizard = $this->has_themewizard_step();
        $doing_logowizard = (function_exists('imagepng')) && (addon_installed('themewizard')) && (get_theme_option('enable_logowizard', null, $source_theme) == '1');

        if ((post_param_integer('skip_8', 0) == 0) && ($doing_themewizard || $doing_logowizard)) {
            require_code('themewizard');

            // Make/set theme and logos
            if ($doing_themewizard) {
                $new_theme_name = substr(preg_replace('#[^' . URL_CONTENT_REGEXP . ']#', '_', $name), 0, 40);

                global $THEME_IMAGES_CACHE;
                $old_img_codes_site = $GLOBALS['SITE_DB']->query_select('theme_images', array('id', 'url'), array('theme' => $GLOBALS['FORUM_DRIVER']->get_theme(), 'lang' => user_lang()));
                if (!file_exists(get_custom_file_base() . '/themes/' . $new_theme_name)) {
                    make_theme($new_theme_name, 'default', 'equations', post_param_string('seed_hex'), /*$use=*/true, post_param_integer('dark', 0) == 1);
                }

                $live_theme = $new_theme_name;
            } else {
                $live_theme = $source_theme;

                require_code('themes3');
                set_live_theme($live_theme);
            }
            if ($doing_logowizard) {
                foreach (array($live_theme, 'default') as $logo_save_theme) {
                    $logo = generate_logo($name, $font, $logo_theme_image, $background_theme_image, false, $logo_save_theme);
                    $path = 'themes/' . $logo_save_theme . '/images_custom/-logo.png';
                    if (!file_exists(get_custom_file_base() . '/' . dirname($path))) {
                        require_code('files2');
                        make_missing_directory(get_custom_file_base() . '/' . dirname($path));
                    }
                    cms_imagesave($logo, get_custom_file_base() . '/' . $path) or intelligent_write_error($path);
                    actual_edit_theme_image('logo/-logo', $logo_save_theme, get_site_default_lang(), 'logo/-logo', $path, true);
                    imagedestroy($logo);

                    $logo = generate_logo($name, $font, $logo_theme_image, $background_theme_image, false, $logo_save_theme, 'standalone');
                    $path = 'themes/' . $logo_save_theme . '/images_custom/standalone_logo.png';
                    cms_imagesave($logo, get_custom_file_base() . '/' . $path) or intelligent_write_error($path);
                    actual_edit_theme_image('logo/standalone_logo', $logo_save_theme, get_site_default_lang(), 'logo/standalone_logo', $path, true);
                    imagedestroy($logo);

                    $logo = generate_logo($name, $font, $logo_theme_image, $background_theme_image, false, $logo_save_theme, 'small');
                    $path = 'themes/' . $logo_save_theme . '/images_custom/small_logo.png';
                    cms_imagesave($logo, get_custom_file_base() . '/' . $path) or intelligent_write_error($path);
                    actual_edit_theme_image('logo/small_logo', $logo_save_theme, get_site_default_lang(), 'logo/small_logo', $path, true);
                    imagedestroy($logo);

                    $logo = generate_logo($name, $font, $logo_theme_image, $background_theme_image, false, $logo_save_theme, 'small_white');
                    $path = 'themes/' . $logo_save_theme . '/images_custom/small_white_logo.png';
                    cms_imagesave($logo, get_custom_file_base() . '/' . $path) or intelligent_write_error($path);
                    actual_edit_theme_image('logo/small_white_logo', $logo_save_theme, get_site_default_lang(), 'logo/small_white_logo', $path, true);
                    imagedestroy($logo);
                }
            }
            if ($doing_themewizard) {
                $contents = '';
                $contents .= 'title=' . $name . "\n";
                $contents .= 'description=' . do_lang('NA') . "\n";
                $contents .= 'seed=' . post_param_string('seed_hex') . "\n";
                $contents .= 'author=Composr' . "\n";
                if (get_theme_option('supports_themewizard_equations', null, post_param_string('source_theme', 'default')) === '1') {
                    $contents .= 'supports_themewizard_equations=1' . "\n";
                }
                cms_file_put_contents_safe(get_custom_file_base() . '/themes/' . filter_naughty($new_theme_name) . '/theme.ini', $contents, FILE_WRITE_FIX_PERMISSIONS | FILE_WRITE_SYNC_FILE);
                $THEME_IMAGES_CACHE['site'] = $old_img_codes_site; // Just so it renders with the old theme
            }
        }

        // Set options
        if (post_param_integer('skip_3', 0) == 0) {
            set_option('site_name', $name);
            set_option('copyright', 'Copyright &copy; ' . $name . ' ' . date('Y'));
            set_option('description', post_param_string('description'));
            set_option('site_scope', post_param_string('site_scope'));
            set_option('copyright', post_param_string('copyright'));
            set_option('staff_address', post_param_string('staff_address'));
            set_option('keywords', post_param_string('keywords'));
            set_option('timezone', post_param_string('timezone'));
            set_option('google_analytics', post_param_string('google_analytics'));
            set_option('fixed_width', post_param_string('fixed_width', '0'));

            $a = $GLOBALS['SITE_DB']->query_select_value('zones', 'zone_header_text', array('zone_name' => ''));
            $GLOBALS['SITE_DB']->query_update('zones', lang_remap('zone_header_text', $a, $header_text), array('zone_name' => ''), '', 1);

            $b = $GLOBALS['SITE_DB']->query_select_value_if_there('zones', 'zone_header_text', array('zone_name' => 'site'));
            if ($b !== null) {
                $GLOBALS['SITE_DB']->query_update('zones', lang_remap('zone_header_text', $b, $header_text), array('zone_name' => 'site'), '', 1);
            }

            // Security level...

            $security_level = post_param_string('security_level');

            $security_level_options = array(
                'csp_enabled' => array(
                    'low' => '0',
                    'medium' => '1',
                    'high' => '1',
                ),
                'session_expiry_time' => array(
                    'low' => '24',
                    'medium' => '3',
                    'high' => '1',
                ),
                'password_reset_process' => array(
                    'low' => 'emailed',
                    'medium' => 'temporary',
                    'high' => 'ultra',
                ),
                'password_expiry_days' => array(
                    'low' => '0',
                    'medium' => '0',
                    'high' => '31',
                ),
                'minimum_password_length' => array(
                    'low' => '5',
                    'medium' => '6',
                    'high' => '8',
                ),
                'minimum_password_strength' => array(
                    'low' => '2',
                    'medium' => '4',
                    'high' => '6',
                ),
                'login_error_secrecy' => array(
                    'low' => '0',
                    'medium' => '0',
                    'high' => '1',
                ),
                'ip_strict_for_sessions' => array(
                    'low' => '1',
                    'medium' => '1',
                    'high' => '1',
                ),
                'crypt_ratchet' => array(
                    'low' => '8',
                    'medium' => '10',
                    'high' => '12',
                ),
                'captcha_single_guess' => array(
                    'low' => '0',
                    'medium' => '1',
                    'high' => '1',
                ),
                'captcha_noise' => array(
                    'low' => '0',
                    'medium' => '1',
                    'high' => '1',
                ),
                'brute_force_threshold' => array(
                    'low' => '32',
                    'medium' => '16',
                    'high' => '8',
                ),
                'audio_captcha' => array(
                    'low' => '1',
                    'medium' => '1',
                    'high' => '0',
                ),
                'url_monikers_enabled' => array(
                    'low' => '1',
                    'medium' => '1',
                    'high' => '0',
                ),
                'maintenance_script_htaccess' => array(
                    'low' => '0',
                    'medium' => '0',
                    'high' => '1',
                ),
            );
            foreach ($security_level_options as $security_level_option => $values) {
                set_option($security_level_option, $values[$security_level]);
            }

            if (get_forum_type() == 'cns') {
                $admin_groups = $GLOBALS['FORUM_DRIVER']->get_super_admin_groups();
                $moderator_groups = $GLOBALS['FORUM_DRIVER']->get_moderator_groups();
                $groups = $GLOBALS['FORUM_DRIVER']->get_usergroup_list(true, true);
                foreach (array_keys($groups) as $id) {
                    switch ($security_level) {
                        case 'low':
                            $GLOBALS['FORUM_DB']->query_update('f_groups', array('g_enquire_on_new_ips' => 0), array('id' => $id), '', 1);
                            break;

                        case 'medium':
                            $is_admin = in_array($id, $admin_groups);
                            $GLOBALS['FORUM_DB']->query_update('f_groups', array('g_enquire_on_new_ips' => $is_admin ? 1 : 0), array('id' => $id), '', 1);
                            break;

                        case 'high':
                            $is_staff = in_array($id, $admin_groups) || in_array($id, $moderator_groups);
                            $GLOBALS['FORUM_DB']->query_update('f_groups', array('g_enquire_on_new_ips' => $is_staff ? 1 : 0), array('id' => $id), '', 1);
                            break;
                    }
                }
            }
        }
        if (post_param_integer('skip_9', 0) == 0) {
            set_option('site_closed', strval(post_param_integer('site_closed', 0)));
            set_option('closed', post_param_string('closed', ''));
        }

        // Set addons
        if ((post_param_integer('skip_4', 0) == 0) && ($GLOBALS['CURRENT_SHARE_USER'] === null)) {
            require_lang('addons');
            require_code('addons2');
            preload_all_ocproducts_addons_info();
            $addons_installed = find_installed_addons(false, true, true);
            $uninstalling = array();
            foreach ($addons_installed as $i => $addon_info) {
                if (post_param_integer('addon_' . $addon_info['name'], 0) == 0 && $addon_info['name'] != 'core' && substr($addon_info['name'], 0, 5) != 'core_') {
                    $uninstalling[$addon_info['name']] = $addon_info;
                }

                $addons_installed[$i] = $addon_info;
            }
            $addons_not_installed = find_available_addons(false);
            $installing = array();
            foreach ($addons_not_installed as $addon_info) {
                if (post_param_integer('addon_' . $addon_info['name'], 0) == 1) {
                    $installing[] = $addon_info['name'];
                }

                $addons_installed[$i] = $addon_info;
            }
            do {
                $cnt = count($uninstalling);
                foreach ($addons_installed as $addon_info) {
                    if (array_key_exists($addon_info['name'], $uninstalling)) {
                        $addon_info['author'] = ''; // Fudge, to stop it dying on warnings for official addons

                        // Check dependencies
                        $dependencies = isset($addon_info['dependencies_on_this']) ? $addon_info['dependencies_on_this'] : array();
                        foreach (array_keys($uninstalling) as $d) {
                            if (in_array($d, $dependencies)) { // Can mark this dependency as irrelevant, as we are uninstalling the addon for it anyway
                                unset($dependencies[array_search($d, $dependencies)]);
                            }
                        }

                        if (count($dependencies) != 0) { // Can't uninstall, has dependencies
                            unset($uninstalling[$addon_info['name']]);
                        }
                    }
                }
            } while ($cnt != count($uninstalling)); // Dependency chains can be complex, so loop until we're stopped finding anything changing

            if (!file_exists(get_file_base() . '/.git')) { // Only uninstall if we're not working from a git repository
                foreach ($uninstalling as $addon_info) {
                    // Archive it off to exports/addons
                    if ($addon_info['files'] != array()) {
                        $file = preg_replace('#^[_\.\-]#', 'x', preg_replace('#[^\w\.\-]#', '_', $addon_info['name'])) . '.tar';
                        create_addon(
                            $file,
                            $addon_info['files'],
                            $addon_info['name'],
                            implode(',', $addon_info['incompatibilities']),
                            implode(',', $addon_info['dependencies']),
                            $addon_info['author'],
                            $addon_info['organisation'],
                            $addon_info['version'],
                            $addon_info['category'],
                            implode("\n", $addon_info['copyright_attribution']),
                            $addon_info['licence'],
                            $addon_info['description'],
                            'imports/addons'
                        );
                    }

                    uninstall_addon($addon_info['name']);
                }
            }
            foreach ($addons_not_installed as $addon_file => $addon_info) {
                if (post_param_integer('addon_' . $addon_info['name'], 0) == 1) {
                    // Check dependencies
                    $dependencies = explode(',', $addon_info['dependencies']);
                    foreach (array_keys($uninstalling) as $d) {
                        if ((addon_installed($d)) || (in_array($d, $installing))) {
                            unset($dependencies[array_search($d, $dependencies)]);
                        }
                    }

                    if (count($dependencies) == 0) { // If all dependencies installed / will be installed
                        install_addon($addon_file);
                    }
                }
            }
        }

        // Set features
        if (post_param_integer('skip_5', 0) == 0) {
            $hooks = find_all_hooks('modules', 'admin_setupwizard');
            foreach (array_keys($hooks) as $hook) {
                if ((post_param_integer('addon_' . $hook, 0) == 1) || ($hook == 'core')) {
                    $path = get_file_base() . '/sources_custom/hooks/modules/admin_setupwizard/' . filter_naughty_harsh($hook) . '.php';
                    if (!file_exists($path)) {
                        $path = get_file_base() . '/sources/hooks/modules/admin_setupwizard/' . filter_naughty_harsh($hook) . '.php';
                    }
                    $_hook_bits = extract_module_functions($path, array('set_fields'));
                    if (is_array($_hook_bits[0])) {
                        call_user_func_array($_hook_bits[0][0], $_hook_bits[0][1]);
                    } else {
                        cms_eval($_hook_bits[0], $path);
                    }
                }
            }
        }

        $collapse_zones = post_param_integer('single_public_zone', 0) == 1;

        // Install test content
        if (post_param_integer('install_test_content', 0) == 1) {
            require_code('setupwizard');
            install_test_content();
        }

        // Rules
        if (post_param_integer('skip_7', 0) == 0) {
            $full_path = get_custom_file_base() . '/pages/comcode_custom/' . get_site_default_lang() . '/_rules.txt';
            if (file_exists($full_path)) {
                @copy($full_path, $full_path . '.' . strval(time()));
                fix_permissions($full_path . '.' . strval(time()));
                sync_file($full_path . '.' . strval(time()));
            }
            $rf = $this->get_rules_file(post_param_string('rules'));
            cms_file_put_contents_safe($full_path, $rf, FILE_WRITE_FIX_PERMISSIONS | FILE_WRITE_SYNC_FILE);
        }

        $block_options = null;
        if (($installprofile != '') && ($object !== null)) {
            $block_options = $object->block_options();
        }

        // Blocks
        if ((post_param_integer('skip_6', 0) == 0) && ($this->has_block_step())) {
            require_code('setupwizard');
            $page_structure = _get_zone_pages($installprofileblocks, $block_options, $collapse_zones, $installprofile);

            foreach ($page_structure as $zone => $zone_pages) {
                // Start
                $full_path = get_custom_file_base() . (($zone == '') ? '' : '/') . $zone . '/pages/comcode_custom/' . get_site_default_lang() . '/' . DEFAULT_ZONE_PAGE_NAME . '.txt';
                if (file_exists($full_path)) {
                    @copy($full_path, $full_path . '.' . strval(time()));
                    fix_permissions($full_path . '.' . strval(time()));
                    sync_file($full_path . '.' . strval(time()));
                }
                cms_file_put_contents_safe($full_path, $zone_pages[DEFAULT_ZONE_PAGE_NAME], FILE_WRITE_FIX_PERMISSIONS | FILE_WRITE_SYNC_FILE);

                // Left
                $full_path = get_custom_file_base() . (($zone == '') ? '' : '/') . $zone . '/pages/comcode_custom/' . get_site_default_lang() . '/panel_left.txt';
                if (file_exists($full_path)) {
                    @copy($full_path, $full_path . '.' . strval(time()));
                    fix_permissions($full_path . '.' . strval(time()));
                    sync_file($full_path . '.' . strval(time()));
                }
                cms_file_put_contents_safe($full_path, $zone_pages['left'], FILE_WRITE_FIX_PERMISSIONS | FILE_WRITE_SYNC_FILE);

                // Right
                $full_path = get_custom_file_base() . (($zone == '') ? '' : '/') . $zone . '/pages/comcode_custom/' . get_site_default_lang() . '/panel_right.txt';
                if (file_exists($full_path)) {
                    @copy($full_path, $full_path . '.' . strval(time()));
                    fix_permissions($full_path . '.' . strval(time()));
                    sync_file($full_path . '.' . strval(time()));
                }
                cms_file_put_contents_safe($full_path, $zone_pages['right'], FILE_WRITE_FIX_PERMISSIONS | FILE_WRITE_SYNC_FILE);
            }
        } elseif (!$this->has_block_step()) {
            require_code('files2');
            foreach (find_all_zones() as $zone) {
                $dir = get_custom_file_base() . '/' . (($zone == '') ? '' : ($zone . '/')) . 'pages/comcode_custom/' . fallback_lang();
                $files = get_directory_contents($dir, '', 0, true, true, array('txt'));
                foreach ($files as $file) {
                    $matches = array();
                    $regexp = '#^\_' . preg_quote($source_theme, '#') . '__([\w\-]+)\.txt$#';
                    if (preg_match($regexp, $file, $matches) != 0) {
                        $page_name = $matches[1];
                        cms_file_put_contents_safe($dir . '/' . $page_name . '.txt', cms_file_get_contents_safe($dir . '/' . $file));
                    }
                }
            }
        }

        delete_cache_entry('menu');

        // We're done
        set_value('setupwizard_completed', '1');

        log_it('SETUPWIZARD');

        $url = build_url(array('page' => '_SELF', 'type' => 'step11'), '_SELF');
        return redirect_screen($this->title, $url, do_lang_tempcode('SUCCESS'));
    }

    /**
     * Clear caches we want to clear to clean up.
     */
    protected function clear_caching()
    {
        require_code('caches3');
        erase_comcode_page_cache();
        erase_block_cache(true);
        //persistent_cache_delete('OPTIONS');  Done by set_option
        erase_persistent_cache();
        erase_cached_templates(false, null, TEMPLATE_DECACHE_WITH_ANYTHING_INTERESTING);
    }

    /**
     * UI for a setup wizard step (done, message after cache emptied - need lower memory usage to rebuild them).
     *
     * @return Tempcode The UI
     */
    public function step11()
    {
        // Clear some caching
        $this->clear_caching();

        require_code('templates_donext');

        require_lang('zones');

        // Show nice interface to start adding pages
        return do_next_manager(
            $this->title,
            do_lang_tempcode('SUCCESS'),
            array(
                array('menu/cms/comcode_page_edit', array('cms_comcode_pages', array('type' => 'edit'), get_module_zone('cms_comcode_pages')), do_lang('COMCODE_PAGE_ADD')),
                array('menu/' . DEFAULT_ZONE_PAGE_NAME, array(null, array(), '')),
                array('menu/cms/cms', array(null, array(), 'cms')),
                array('menu/adminzone/adminzone', array(null, array(), 'adminzone')),
            ),
            do_lang('PAGES'),
            null,
            null,
            null,
            null,
            null,
            null,
            null,
            null,
            null,
            array(),
            array(),
            array(),
            null,
            paragraph(do_lang_tempcode('SETUPWIZARD_10_DESCRIBE'))
        );
    }

    /**
     * Install test content.
     *
     * @return Tempcode The UI
     */
    public function install_test_content()
    {
        if ($_SERVER['REQUEST_METHOD'] != 'POST') {
            $post_url = build_url(array('page' => '_SELF', 'type' => 'install_test_content'), '_SELF');

            return do_template('CONFIRM_SCREEN', array('_GUID' => 'a91c415cb14fcc78f98c36e67229894c', 'TITLE' => $this->title, 'TEXT' => do_lang_tempcode('Q_SURE'), 'URL' => $post_url, 'HIDDEN' => '', 'FIELDS' => ''));
        }

        require_code('setupwizard');
        install_test_content();

        return inform_screen($this->title, do_lang_tempcode('SUCCESS'));
    }

    /**
     * Uninstall test content.
     *
     * @return Tempcode The UI
     */
    public function uninstall_test_content()
    {
        if ($_SERVER['REQUEST_METHOD'] != 'POST') {
            $post_url = build_url(array('page' => '_SELF', 'type' => 'uninstall_test_content'), '_SELF');

            return do_template('CONFIRM_SCREEN', array('_GUID' => '1ae3e932b2fa1f32ffebb531c0278ab7', 'TITLE' => $this->title, 'TEXT' => do_lang_tempcode('Q_SURE'), 'URL' => $post_url, 'HIDDEN' => '', 'FIELDS' => ''));
        }

        require_code('setupwizard');
        uninstall_test_content();

        return inform_screen($this->title, do_lang_tempcode('SUCCESS'));
    }

    /**
     * Get the number of steps that the user will see.
     *
     * @return integer The number of steps
     */
    protected function get_num_steps_enumerable()
    {
        $steps = 10;
        if (!$this->has_block_step()) {
            $steps--;
        }
        if (!$this->has_themewizard_step()) {
            $steps--;
        }
        return $steps;
    }

    /**
     * Get the effective step number, when missing steps are considered.
     *
     * @param  integer $step System step number
     * @return integer Effective step number
     */
    protected function get_effective_step($step)
    {
        if ($step > 6) {
            if (!$this->has_block_step()) {
                $step--;
            }
        }
        if ($step > 8) {
            if (!$this->has_themewizard_step()) {
                $step--;
            }
        }
        return $step;
    }

    /**
     * Find if the block selection step will run.
     *
     * @return boolean Whether it will
     */
    protected function has_block_step()
    {
        return (get_theme_option('setupwizard__provide_block_choice', null, post_param_string('source_theme', 'default')) == '1');
    }

    /**
     * Find if the Theme Wizard step will run.
     *
     * @return boolean Whether it will
     */
    protected function has_themewizard_step()
    {
        return (function_exists('imagepng')) && (addon_installed('themewizard')) && (get_theme_option('enable_themewizard', null, post_param_string('source_theme', 'default')) == '1');
    }
}
