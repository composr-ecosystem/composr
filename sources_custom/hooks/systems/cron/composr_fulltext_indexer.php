<?php /*

 Composr
 Copyright (c) ocProducts, 2004-2016

 See text/EN/licence.txt for full licencing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

/**
 * @license    http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright  ocProducts Ltd
 * @package    nusearch
 */

/**
 * Hook class.
 */
class Hook_cron_composr_fulltext_indexer
{
    /**
     * Run function for CRON hooks. Searches for tasks to perform.
     */
    public function run()
    {
        $time = time();
        $_last_cron_time = get_value('last_composr_fulltext_indexer_time', null, true);
        $last_cron_time = ($_last_cron_time === null) ? null : intval($_last_cron_time);

        $total_singular_ngram_tokens = 0;
        $statistics_map = array();

        require_code('search');

        $hooks = find_all_hooks('modules', 'search'); // TODO: Change in v11
        foreach (array_keys($hooks) as $hook) {
            require_code('hooks/modules/search/' . $hook);
            $ob = object_factory('Hook_search_' . $hook);

            if (method_exists($ob, 'index_for_search')) {
                $info = $ob->info(false);
                if ($info !== null) {
                    $ob->index_for_search($last_cron_time, $total_singular_ngram_tokens, $statistics_map);
                }
            }
        }

        // Log all ngram commonality to the database
        if (!empty($statistics_map)) { // If was a full reindex
            $GLOBALS['SITE_DB']->query_delete('ft_index_commonality');
            foreach ($statistics_map as $lang => $_statistics_map) {
                foreach ($_statistics_map as $ngram => $total) {
                    $GLOBALS['SITE_DB']->query_insert('ft_index_commonality', array(
                        'c_ngram' => $ngram,
                        'c_commonality' => floatval($total) / floatval($total_singular_ngram_tokens),
                    ));
                }
            }
        }

        set_value('last_composr_fulltext_indexer_time', strval($time), true);
    }
}
