<?php /*

 Composr
 Copyright (c) ocProducts, 2004-2022

 See docs/LICENSE.md for full licensing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

/**
 * @license    http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright  ocProducts Ltd
 * @package    points
 */

/**
 * Standard code module initialisation function.
 *
 * @ignore
 */
function init__points()
{
    global $TOTAL_POINTS_CACHE;
    $TOTAL_POINTS_CACHE = [];
    global $POINTS_SPENT_CACHE;
    $POINTS_SPENT_CACHE = [];
    global $POINT_INFO_CACHE;
    $POINT_INFO_CACHE = [];
}

/**
 * Get the price of the specified item for sale (only for tableless items).
 *
 * @param  ID_TEXT $item The name of the item
 * @return integer The price of the item
 */
function get_product_price_points(string $item) : int
{
    return $GLOBALS['SITE_DB']->query_select_value('ecom_prods_prices', 'price_points', ['name' => $item]);
}

/**
 * Get the total points in the specified member's account; some of these will probably have been spent already.
 *
 * @param  MEMBER $member_id The member
 * @param  ?TIME $timestamp Time to get for (null: now)
 * @param  boolean $cache Whether to retrieve from and store the results in the run-time cache
 * @return integer The number of points the member has
 */
function total_points(int $member_id, ?int $timestamp = null, bool $cache = true) : int
{
    if (!has_privilege($member_id, 'use_points')) {
        return 0;
    }

    if ($cache) {
        global $TOTAL_POINTS_CACHE;

        if ($timestamp === null) {
            if (isset($TOTAL_POINTS_CACHE[$member_id])) {
                return $TOTAL_POINTS_CACHE[$member_id];
            }
        }
    }

    $point_info = point_info($member_id, $cache);
    $points = 0;

    // Run points hooks
    $hook_obs = find_all_hook_obs('systems', 'points', 'Hook_points_');
    foreach ($hook_obs as $hook_ob) {
        $points += $hook_ob->total_points($member_id, $timestamp, $point_info);
    }

    if ($timestamp === null && $cache) {
        $TOTAL_POINTS_CACHE[$member_id] = $points;
    }

    return $points;
}

/**
 * Get the total points the specified member has spent, including sent to other members.
 *
 * @param  MEMBER $member_id The member
 * @return integer The number of points the member has spent
 */
function points_spent(int $member_id) : int
{
    global $POINTS_SPENT_CACHE;
    if (isset($POINTS_SPENT_CACHE[$member_id])) {
        return $POINTS_SPENT_CACHE[$member_id];
    }

    $_points = point_info($member_id);
    $points = isset($_points['points_spent']) ? $_points['points_spent'] : 0;
    $POINTS_SPENT_CACHE[$member_id] = $points;

    return $points;
}

/**
 * Get the total points the specified member has spent, but only to the system.
 *
 * @param  MEMBER $member_id The member
 * @return integer The number of points the member has spent to the system
 */
function points_spent_system(int $member_id) : int
{
    $_spent = $GLOBALS['SITE_DB']->query_select_value_if_there('points_ledger', 'SUM(amount_points)', ['sender_id' => $member_id, 'recipient_id' => $GLOBALS['FORUM_DRIVER']->get_guest_id(), 'status' => 'normal']);
    $actual_spent = @intval($_spent); // Most reliable way
    return $actual_spent;
}

/**
 * Get the number of points a member has to spend.
 *
 * @param  MEMBER $member_id The member
 * @return integer The number of points the member has to spend
 */
function points_balance(int $member_id) : int
{
    if (!has_privilege($member_id, 'use_points')) {
        return 0;
    }

    return total_points($member_id) - points_spent($member_id);
}

/**
 * Get all sorts of information about a specified member's point account.
 *
 * @param  MEMBER $member_id The member the point info is of
 * @param  boolean $cache Whether to retrieve from and store the results in a run-time cache
 * @return array The map containing the members point info (fields as enumerated in description)
 */
function point_info(int $member_id, bool $cache = true) : array
{
    require_code('lang');
    require_lang('points');

    if ($cache) {
        global $POINT_INFO_CACHE;
        if (isset($POINT_INFO_CACHE[$member_id])) {
            return $POINT_INFO_CACHE[$member_id];
        }
    }

    $values = $GLOBALS['FORUM_DRIVER']->get_custom_fields($member_id);
    if ($values === null) {
        $values = [];
    }

    $ret = [];
    $ret[$member_id] = [];
    foreach ($values as $key => $val) {
        if (!isset($val->codename/*faster than is_object*/)) {
            $ret[$member_id][$key] = @intval($val);
        }
    }
    if ($cache) {
        $POINT_INFO_CACHE[$member_id] = $ret[$member_id];
    }
    return $ret[$member_id];
}

/**
 * Get the number of gift points sent by the given member.
 * If gift points is disabled, this function provides a ceremonial figure rather than a mathematical figure.
 *
 * @param  MEMBER $member_id The member we want it for
 * @return integer The number of gift points sent by the member to others
 */
function gift_points_sent(int $member_id) : int
{
    $_sent = point_info($member_id);

    if ((!isset($_sent['gift_points_sent'])) || (get_option('enable_gift_points') == '0')) { // Either DB error or gift points disabled
        $_actual_sent = $GLOBALS['SITE_DB']->query_select_value_if_there('points_ledger', 'SUM(amount_gift_points)', ['sender_id' => $member_id, 'status' => 'normal']);
        $actual_sent = @intval($_actual_sent); // Most reliable way
        return $actual_sent;
    }

    return $_sent['gift_points_sent'];
}

/**
 * Get the total points the provided member sent to other members (and not the system). This includes gift points.
 *
 * @param  MEMBER $member_id The member which to get the total sent points
 * @return integer The total number of points the member sent to other members
 */
function total_points_sent(int $member_id) : int
{
    $_sent = $GLOBALS['SITE_DB']->query_select_value_if_there('points_ledger', '(SUM(amount_gift_points)+SUM(amount_points))', ['sender_id' => $member_id, 'status' => 'normal'], ' AND recipient_id<>' . strval($GLOBALS['FORUM_DRIVER']->get_guest_id()));
    $actual_sent = @intval($_sent); // Most reliable way
    return $actual_sent;
}

/**
 * Get the number of gift points that the given member has which they can send to others.
 *
 * @param  MEMBER $member_id The member we want it for
 * @return integer The number of gifts points that the given member has
 */
function gift_points_balance(int $member_id) : int
{
    // If gift points is disabled, return point balance instead.
    if (get_option('enable_gift_points') == '0') {
        return points_balance($member_id);
    }

    $sent = gift_points_sent($member_id);
    if (get_forum_type() == 'cns') {
        require_lang('cns');
        require_code('cns_groups');

        $base = cns_get_member_best_group_property($member_id, 'gift_points_base');
        $per_day = cns_get_member_best_group_property($member_id, 'gift_points_per_day');
    } else {
        $base = 25;
        $per_day = 1;
    }
    $available = $base + $per_day * intval(floor((time() - $GLOBALS['FORUM_DRIVER']->get_member_join_timestamp($member_id)) / (60 * 60 * 24))) - $sent;

    return $available;
}

/**
 * Generate a proper URL to a member's points profile and optionally pre-populate fields for sending / modifying points.
 *
 * @param  MEMBER $member_id The member to view the profile
 * @param  boolean $skip_keep Whether to skip actually putting on keep_ parameters (rarely will this skipping be desirable)
 * @param  ?integer $send_amount The number of points to pre-populate in the send / modify form (null: leave blank)
 * @param  ?SHORT_TEXT $send_reason The reason to pre-populate in the send / modify form (null: leave blank)
 * @param  ?ID_TEXT $trans_type The type of transaction to pre-select (ignored for those without "Moderate points" privilege) (null: do not set a default)
 * @set send credit debit
 * @return Tempcode The URL to the member's points profile
 *
 */
function points_url(int $member_id, bool $skip_keep = false, ?int $send_amount = null, ?string $send_reason = null, ?string $trans_type = null) : object
{
    $map = [];
    if ($trans_type !== null) {
        $map['trans_type'] = $trans_type;
    }
    if ($send_amount !== null) {
        $map['send_amount'] = $send_amount;
    }
    if ($send_reason !== null) {
        $map['send_reason'] = $send_reason;
    }

    if (get_forum_type() == 'cns') {
        $url = $GLOBALS['FORUM_DRIVER']->member_profile_url($member_id, true, null, ['conversr_tab' => 'points', 'extra_get_params' => $map]);
        if (!is_object($url)) {
            $url = make_string_tempcode($url);
        }
    } else {
        $map = array_merge($map, ['page' => 'points', 'type' => 'member', 'id' => $member_id]);
        $url = build_url($map, get_module_zone('points'));
    }

    return $url;
}
