<?php /*

 Composr
 Copyright (c) ocProducts, 2004-2019

 See text/EN/licence.txt for full licensing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

/**
 * @license    http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright  ocProducts Ltd
 * @package    points
 */

/**
 * Standard code module initialisation function.
 *
 * @ignore
 */
function init__points()
{
    global $TOTAL_POINTS_CACHE;
    $TOTAL_POINTS_CACHE = [];
    global $POINTS_USED_CACHE;
    $POINTS_USED_CACHE = [];
    global $POINT_INFO_CACHE;
    $POINT_INFO_CACHE = [];
}

/**
 * Get the price of the specified item for sale (only for tableless items).
 *
 * @param  ID_TEXT $item The name of the item
 * @return integer The price of the item
 */
function get_product_price_points($item)
{
    return $GLOBALS['SITE_DB']->query_select_value('ecom_prods_prices', 'price_points', ['name' => $item]);
}

/**
 * Get the total points in the specified member's account; some of these will probably have been spent already.
 *
 * @param  MEMBER $member_id The member
 * @param  ?TIME $timestamp Time to get for (null: now)
 * @return integer The number of points the member has
 */
function total_points($member_id, $timestamp = null)
{
    if (!has_privilege($member_id, 'use_points')) {
        return 0;
    }

    global $TOTAL_POINTS_CACHE;

    if ($timestamp === null) {
        if (isset($TOTAL_POINTS_CACHE[$member_id])) {
            return $TOTAL_POINTS_CACHE[$member_id];
        }
    }

    $point_info = point_info($member_id);
    $points = 0;

    // Run points hooks
    $hooks = find_all_hooks('modules', 'points');
    foreach (array_keys($hooks) as $hook) {
        require_code('hooks/modules/points/' . filter_naughty_harsh($hook));
        $object = object_factory('Hook_points_' . filter_naughty_harsh($hook), true);
        if ($object === null) {
            continue;
        }
        $points += $object->total_points($member_id, $timestamp, $point_info);
    }

    if ($timestamp === null) {
        $TOTAL_POINTS_CACHE[$member_id] = $points;
    }

    return $points;
}

/**
 * Get the total points the specified member has used (spent).
 *
 * @param  MEMBER $member_id The member
 * @return integer The number of points the member has spent
 */
function points_used($member_id)
{
    global $POINTS_USED_CACHE;
    if (isset($POINTS_USED_CACHE[$member_id])) {
        return $POINTS_USED_CACHE[$member_id];
    }

    $_points = point_info($member_id);
    $points = isset($_points['points_used']) ? $_points['points_used'] : 0;
    $POINTS_USED_CACHE[$member_id] = $points;

    return $points;
}

/**
 * Get the total points the specified member has.
 *
 * @param  MEMBER $member_id The member
 * @return integer The number of points the member has
 */
function available_points($member_id)
{
    if (!has_privilege($member_id, 'use_points')) {
        return 0;
    }

    return total_points($member_id) - points_used($member_id);
}

/**
 * Get all sorts of information about a specified member's point account.
 *
 * @param  MEMBER $member_id The member the point info is of
 * @return array The map containing the members point info (fields as enumerated in description)
 */
function point_info($member_id)
{
    require_code('lang');
    require_lang('points');

    global $POINT_INFO_CACHE;
    if (isset($POINT_INFO_CACHE[$member_id])) {
        return $POINT_INFO_CACHE[$member_id];
    }

    $values = $GLOBALS['FORUM_DRIVER']->get_custom_fields($member_id);
    if ($values === null) {
        $values = [];
    }

    $POINT_INFO_CACHE[$member_id] = [];
    foreach ($values as $key => $val) {
        if (!isset($val->codename/*faster than is_object*/)) {
            $POINT_INFO_CACHE[$member_id][$key] = @intval($val);
        }
    }

    return $POINT_INFO_CACHE[$member_id];
}

/**
 * Get the number of gift points used by the given member.
 *
 * @param  MEMBER $member_id The member we want it for
 * @return integer The number of gift points used by the member
 */
function get_gift_points_used($member_id)
{
    $_actual_used = $GLOBALS['SITE_DB']->query_select_value_if_there('gifts', 'SUM(amount)', ['gift_from' => $member_id]);
    $actual_used = @intval($_actual_used); // Most reliable way
    $_used = point_info($member_id);
    if (!isset($_used['gift_points_used'])) { // Some kind of DB error
        return $actual_used;
    }
    $claimed_used = $_used['gift_points_used'];
    return ($claimed_used < 0) ? $claimed_used : $actual_used; // Still allows $claimed_used to be fiddled to negative give members extra gift points
}

/**
 * Get the number of gifts points to give that the given member has.
 *
 * @param  MEMBER $member_id The member we want it for
 * @return integer The number of gifts points to give that the given member has
 */
function get_gift_points_to_give($member_id)
{
    $used = get_gift_points_used($member_id);
    if (get_forum_type() == 'cns') {
        require_lang('cns');
        require_code('cns_groups');

        $base = cns_get_member_best_group_property($member_id, 'gift_points_base');
        $per_day = cns_get_member_best_group_property($member_id, 'gift_points_per_day');
    } else {
        $base = 25;
        $per_day = 1;
    }
    $available = $base + $per_day * intval(floor((time() - $GLOBALS['FORUM_DRIVER']->get_member_join_timestamp($member_id)) / (60 * 60 * 24))) - $used;

    return $available;
}
