<?php /*

 Composr
 Copyright (c) ocProducts, 2004-2021

 See docs/LICENSE.md for full licensing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

/**
 * @license    http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright  ocProducts Ltd
 * @package    leader_board
 */

/**
 * Create a new leader-board.
 *
 * @param SHORT_TEXT $title The leader-board title
 * @param SHORT_TEXT $leader_board_type The type of leader-board
 * @param INTEGER $member_count The number of top members to use for this leader-board
 * @param SHORT_TEXT $timeframe The frequency which to re-calculate the leader-board
 * @param BINARY $rolling Whether or not re-calculation should be relative to the creation time of the leader-board
 * @param BINARY $include_staff Whether or not to include staff in the leader-board
 * @param INTEGER|null $usergroup Only allow members from this usergroup to be included in the leader-board (null: do not apply a usergroup restriction)
 * @return INTEGER The id of the new leader-board
 */
function add_leader_board(string $title, string $leader_board_type, int $member_count, string $timeframe, int $rolling, int $include_staff, ?int $usergroup) : int
{
    // Cannot have less than one member
    if ($member_count < 1) {
        warn_exit(do_lang_tempcode('IMPROPERLY_FILLED_IN'));
    }

    // Time frame must be valid
    if (!in_array($timeframe, ['week', 'month', 'year'])) {
        warn_exit(do_lang_tempcode('IMPROPERLY_FILLED_IN'));
    }

    return $GLOBALS['SITE_DB']->query_insert('leader_boards', [
        'lb_title' => $title,
        'lb_type' => $leader_board_type,
        'lb_creation_date_and_time' => time(),
        'lb_member_count' => $member_count,
        'lb_timeframe' => $timeframe,
        'lb_rolling' => $rolling != 0 ? 1 : 0,
        'lb_include_staff' => $include_staff != 0 ? 1 : 0,
        'lb_usergroup' => $usergroup
    ], true);
}

/**
 * Edit a leader-board.
 *
 * @param INTEGER $id The id of the leader-board to edit
 * @param SHORT_TEXT $title The leader-board title
 * @param SHORT_TEXT|null $leader_board_type The type of leader-board (null: do not change)
 * @param INTEGER $member_count The number of top members to use for this leader-board
 * @param SHORT_TEXT $timeframe The frequency which to re-calculate the leader-board
 * @param BINARY $rolling Whether or not re-calculation should be relative to the creation time of the leader-board
 * @param BINARY $include_staff Whether or not to include staff in the leader-board
 * @param INTEGER|null $usergroup Only allow members from this usergroup to be included in the leader-board (null: do not apply a usergroup restriction)
 */
function edit_leader_board(int $id, string $title, ?string $leader_board_type = null, int $member_count, string $timeframe, int $rolling, int $include_staff, ?int $usergroup)
{
    $_title = $GLOBALS['SITE_DB']->query_select_value_if_there('leader_boards', 'lb_title', ['id' => $id]);
    if ($_title === null) {
        warn_exit(do_lang_tempcode('MISSING_RESOURCE', 'leader_board'));
    }

    // Cannot have less than one member
    if ($member_count < 1) {
        warn_exit(do_lang_tempcode('IMPROPERLY_FILLED_IN'));
    }

    // Time frame must be valid
    if (!in_array($timeframe, ['week', 'month', 'year'])) {
        warn_exit(do_lang_tempcode('IMPROPERLY_FILLED_IN'));
    }

    $map = [
        'lb_title' => $title,
        'lb_creation_date_and_time' => time(),
        'lb_member_count' => $member_count,
        'lb_timeframe' => $timeframe,
        'lb_rolling' => $rolling != 0 ? 1 : 0,
        'lb_include_staff' => $include_staff != 0 ? 1 : 0,
        'lb_usergroup' => $usergroup
    ];
    if ($leader_board_type !== null) {
        $map['lb_type'] = $leader_board_type;
    }

    $GLOBALS['SITE_DB']->query_update('leader_boards', $map, ['id' => $id]);
}

/**
 * Delete a leader-board and its result sets.
 *
 * @param INTEGER $id The id of the leader-board to delete
 */
function delete_leader_board(int $id)
{
    $_title = $GLOBALS['SITE_DB']->query_select_value_if_there('leader_boards', 'lb_title', ['id' => $id]);
    if ($_title === null) {
        warn_exit(do_lang_tempcode('MISSING_RESOURCE', 'leader_board'));
    }

    $GLOBALS['SITE_DB']->query_delete('leader_boards', ['id' => $id], '', 1);
    $GLOBALS['SITE_DB']->query_delete('leader_board', ['lb_leader_board_id' => $id]);
}
