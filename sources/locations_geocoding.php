<?php /*

 Composr
 Copyright (c) ocProducts, 2004-2020

 See docs/LICENSE.md for full licensing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

/**
 * @license    http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright  ocProducts Ltd
 * @package    core
 */

/**
 * Standard code module initialisation function.
 *
 * @ignore
 */
function init__locations_geocoding()
{
    require_lang('locations');
}

/**
 * Pick which geocoding service to use.
 *
 * @param  ?string $service Force geocoding through a particular service (null: not enforced)
 * @set google bing mapquest
 * @return ?object Service to use (null: no service, which should be impossible as there's always something)
 */
function choose_geocoding_service(&$service = null)
{
    $hook_obs = find_all_hook_obs('systems', 'geocoding', 'Hook_geocoding_');
    foreach ($hook_obs as $hook => $hook_ob) {
        if ($service !== null) {
            if ($service === $hook) {
                return $hook_ob;
            }
        } else {
            if ($hook_ob->is_available()) {
                $service = $hook;
                return $hook_ob;
            }
        }
    }
    return null;
}

/**
 * Geocode a written location.
 *
 * @param  string $location Written location
 * @param  ?Tempcode $error_msg Error message (written by reference) (null: not returned)
 * @param  ?string $service Force geocoding through a particular service (null: not enforced)
 * @set google bing mapquest
 * @return ?array A pair: Latitude, Longitude (null: error)
 */
function geocode($location, &$error_msg = null, $service = null)
{
    $ob = choose_geocoding_service($service);
    if ($ob === null) {
        $error_msg = do_lang('API_NOT_CONFIGURED');
        return null;
    }
    return $ob->geocode($location, $error_msg);
}

/**
 * Geocode a latitude & longitude.
 *
 * @param  float $latitude Latitude
 * @param  float $longitude Longitude
 * @param  ?Tempcode $error_msg Error message (written by reference) (null: not returned)
 * @param  ?string $service Force geocoding through a particular service (null: not enforced)
 * @set google bing mapquest
 * @return ?array A tuple: Formatted address, Street Address, City, County, State, Zip/Postcode, Country (null: error)
 */
function reverse_geocode($latitude, $longitude, &$error_msg = null, $service = null)
{
    $ob = choose_geocoding_service($service);
    return $ob->reverse_geocode($latitude, $longitude, $error_msg);
}
