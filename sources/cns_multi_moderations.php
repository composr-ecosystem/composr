<?php /*

 Composr
 Copyright (c) Christopher Graham, 2004-2024

 See docs/LICENSE.md for full licensing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

/**
 * @license    http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright  Christopher Graham
 * @package    cns_multi_moderations
 */

/**
 * Add a Multi Moderation to the system.
 *
 * @param  SHORT_TEXT $name The name of the Multi Moderation
 * @param  LONG_TEXT $post_text The post text to add when applying (blank: don't add a post)
 * @param  ?AUTO_LINK $move_to The forum to move the topic when applying (null: do not move)
 * @param  ?BINARY $pin_state The pin state after applying (null: unchanged)
 * @param  ?BINARY $open_state The open state after applying (null: unchanged)
 * @param  SHORT_TEXT $forum_multi_code The forum multi code for where this Multi Moderation may be applied
 * @param  SHORT_TEXT $title_suffix The title suffix
 * @return AUTO_LINK The ID of the Multi Moderation just added
 */
function cns_make_multi_moderation(string $name, string $post_text, ?int $move_to, ?int $pin_state, ?int $open_state, string $forum_multi_code = '*', string $title_suffix = '') : int
{
    if (!addon_installed('cns_multi_moderations')) {
        warn_exit(do_lang_tempcode('MISSING_ADDON', escape_html('cns_multi_moderations')));
    }

    require_code('global4');
    prevent_double_submit('ADD_MULTI_MODERATION', null, $name);

    $map = [
        'mm_post_text' => $post_text,
        'mm_move_to_forum_id' => $move_to,
        'mm_pin_state' => $pin_state,
        'mm_open_state' => $open_state,
        'mm_forum_multi_code' => $forum_multi_code,
        'mm_title_suffix' => $title_suffix,
    ];
    $map += insert_lang('mm_name', $name, 3, $GLOBALS['FORUM_DB']);
    $id = $GLOBALS['FORUM_DB']->query_insert('f_multi_moderations', $map, true);

    require_lang('cns_multi_moderations');
    log_it('ADD_MULTI_MODERATION', strval($id), $name);

    if ((addon_installed('commandr')) && (!running_script('install')) && (!get_mass_import_mode())) {
        require_code('resource_fs');
        generate_resource_fs_moniker('multi_moderation', strval($id), null, null, true);
    }

    return $id;
}

/**
 * List all the Multi Moderations that may be used in a certain forum.
 *
 * @param  ?AUTO_LINK $forum_id The forum we are listing for (null: private topics)
 * @return array List of multi moderations
 */
function cns_list_multi_moderations(?int $forum_id) : array
{
    if (!addon_installed('cns_multi_moderations')) {
        return [];
    }

    if ($forum_id === null) {
        return [];
    }

    $rows = $GLOBALS['FORUM_DB']->query_select('f_multi_moderations', ['*'], [], 'ORDER BY ' . $GLOBALS['FORUM_DB']->translate_field_ref('mm_name'));
    $out = [];
    if (empty($rows)) {
        return $out;
    }

    $lots_of_forums = $GLOBALS['FORUM_DB']->query_select_value('f_forums', 'COUNT(*)') > 200;
    if (!$lots_of_forums) {
        $all_forums = collapse_2d_complexity('id', 'f_parent_forum_id', $GLOBALS['FORUM_DB']->query_select('f_forums', ['id', 'f_parent_forum_id']));
    }
    foreach ($rows as $row) {
        $row['_mm_name'] = get_translated_text($row['mm_name'], $GLOBALS['FORUM_DB']);

        if ($row['mm_forum_multi_code'] == '*') {
            $out[$row['id']] = $row['_mm_name'];
            continue;
        }

        require_code('selectcode');
        if ($lots_of_forums) {
            $sql = selectcode_to_sqlfragment($row['mm_forum_multi_code'], 'id', 'f_forums', 'f_parent_forum_id', 'f_parent_forum_id', 'id', true, true, $GLOBALS['FORUM_DB']);
            if ($GLOBALS['FORUM_DB']->query_value_if_there('SELECT id FROM ' . $GLOBALS['FORUM_DB']->get_table_prefix() . 'f_forums WHERE id=' . strval($forum_id) . ' AND (' . $sql . ')', false, true) !== null) {
                $out[$row['id']] = $row['_mm_name'];
            }
        } else {
            $idlist = selectcode_to_idlist_using_memory($row['mm_forum_multi_code'], $all_forums, 'f_forums', 'f_parent_forum_id', 'f_parent_forum_id', 'id', true, true, $GLOBALS['FORUM_DB']);
            if (in_array($forum_id, $idlist)) {
                $out[$row['id']] = $row['_mm_name'];
            }
        }
    }
    return $out;
}

/**
 * Whether a certain member may perform Multi Moderations in a certain forum.
 *
 * @param  ?AUTO_LINK $forum_id The forum (null: private topics)
 * @param  ?MEMBER $member_id The member (null: current member)
 * @return boolean Answer
 */
function cns_may_perform_multi_moderation(?int $forum_id, ?int $member_id = null) : bool
{
    if ($member_id === null) {
        $member_id = get_member();
    }

    if (!cns_may_moderate_forum($forum_id, $member_id)) {
        return false;
    }

    return has_privilege($member_id, 'run_multi_moderations');
}
