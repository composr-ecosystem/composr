<?php /*

 Composr
 Copyright (c) ocProducts, 2004-2019

 See text/EN/licence.txt for full licensing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

/**
 * @license    http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright  ocProducts Ltd
 * @package    core
 */

/**
 * Output a cached stats SVG file.
 *
 * @ignore
 */
function stats_graph_script()
{
    header('X-Robots-Tag: noindex');

    header('Content-Type: image/svg+xml; charset=' . get_charset());

    $file = filter_naughty(get_param_string('file'));

    $path = get_custom_file_base() . '/data_custom/modules/admin_stats/' . $file . '.xml';

    if (file_exists($path)) {
        echo cms_file_get_contents_safe($path, FILE_READ_LOCK | FILE_READ_BOM);
    }
}

/**
 * Function to find Alexa details of the site.
 *
 * @param  string $url The URL of the site which you want to find out information on.)
 * @return array Returns a pair with the rank, and the amount of links
 */
function get_alexa_rank($url)
{
    $test = get_value_newer_than('alexa__' . md5($url), time() - 60 * 60 * 24 * 5, true);
    if ($test !== null) {
        return unserialize($test);
    }

    $_url = 'https://www.alexa.com/minisiteinfo/' . urlencode($url);
    $result = http_get_contents($_url, ['convert_to_internal_encoding' => true, 'trigger_error' => false, 'timeout' => 2.0]);
    if ($result === null) {
        return ['', ''];
    }

    $matches = [];
    if (preg_match('#([\d,]+)\s*</a>\s*</div>\s*<div class="label">Alexa Traffic Rank#s', $result, $matches) != 0) {
        $rank = integer_format(intval(str_replace(',', '', $matches[1])));
    } else {
        $rank = '';
    }
    if (preg_match('#([\d,]+)\s*</a>\s*</div>\s*<div class="label">Sites Linking In#s', $result, $matches) != 0) {
        $links = integer_format(intval(str_replace(',', '', $matches[1])));
    } else {
        $links = '';
    }

    // we would like, but cannot get (without an API key)...
    /*
        time on site
        reach (as a percentage)
        page views
        audience (i.e. what country views the site most)
     */

    $ret = [$rank, $links];

    set_value('alexa__' . md5($url), serialize($ret), true);

    return $ret;
}
