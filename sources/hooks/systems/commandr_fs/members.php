<?php /*

 Composr
 Copyright (c) ocProducts, 2004-2016

 See text/EN/licence.txt for full licencing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

/**
 * @license    http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright  ocProducts Ltd
 * @package    core_cns
 */

/**
 * Hook class.
 */
class Hook_commandr_fs_members
{
    /**
     * Standard Commandr-fs listing function for commandr_fs hooks.
     *
     * @param  array $meta_dir The current meta-directory path
     * @param  string $meta_root_node The root node of the current meta-directory
     * @param  object $commandr_fs A reference to the Commandr filesystem object
     * @return ~array The final directory listing (false: failure)
     */
    public function listing($meta_dir, $meta_root_node, &$commandr_fs)
    {
        if (get_forum_type() != 'cns') {
            return false;
        }

        $listing = array();
        if (count($meta_dir) < 1) {
            // We're listing the users
            $cnt = $GLOBALS['SITE_DB']->query_select_value('f_members', 'COUNT(*)');
            if ($cnt > 1000) {
                return false; // Too much to process
            }

            $users = $GLOBALS['SITE_DB']->query_select('f_members', array('id', 'm_username', 'm_join_time'));
            foreach ($users as $user) {
                $query = 'SELECT MAX(date_and_time) FROM ' . get_table_prefix() . 'actionlogs WHERE ' . db_string_equal_to('param_a', strval($user['id'])) . ' AND  (' . db_string_equal_to('the_type', 'EDIT_EDIT_MEMBER_PROFILE') . ')';
                $modification_time = $GLOBALS['SITE_DB']->query_value_if_there($query);
                if (is_null($modification_time)) {
                    $modification_time = $user['m_join_time'];
                }

                $listing[] = array(
                    $user['m_username'],
                    COMMANDR_FS_DIR,
                    null/*don't calculate a filesize*/,
                    $modification_time,
                );
            }
        } elseif (count($meta_dir) == 1) {
            // We're listing the profile fields and custom profile fields of the specified member
            $username = $meta_dir[0];
            $_member_data = $GLOBALS['SITE_DB']->query_select('f_members', array('*'), array('m_username' => $username), '', 1);
            if (!array_key_exists(0, $_member_data)) {
                return false;
            }
            $member_data = $_member_data[0];
            $props = array(
                'id',
                'theme',
                'avatar',
                'validated',
                'timezone_offset',
                'primary_group',
                'signature',
                'banned',
                'preview_posts',
                'dob_day',
                'dob_month',
                'dob_year',
                'reveal_age',
                'e-mail',
                'title',
                'photo',
                'photo_thumb',
                'view_signatures',
                'auto_monitor_contrib_content',
                'language',
                'allow_e-mails',
                'notes',
                'wide',
                'max_attach_size'
            );

            $listing = array();
            foreach ($props as $prop) {
                $listing[] = array(
                    $prop,
                    COMMANDR_FS_FILE,
                    strlen($member_data['m_' . $prop]),
                    $member_data['m_join_time'],
                );
            }
            $listing[] = array(
                'groups',
                COMMANDR_FS_DIR,
                null/*don't calculate a filesize*/,
                $member_data['m_join_time'],
            );

            // Custom profile fields
            $_member_custom_fields = $GLOBALS['SITE_DB']->query_select('f_member_custom_fields', array('*'), array('mf_member_id' => $member_data['id']));
            if (!array_key_exists(0, $_member_custom_fields)) {
                return false;
            }
            $member_custom_fields = $_member_custom_fields[0];

            foreach (array_keys($member_custom_fields) as $_i) {
                $i = intval(substr($_i, strlen('field_')));
                $cpf_value = $member_custom_fields['field_' . strval($i)];
                $cpf_name = get_translated_text($GLOBALS['SITE_DB']->query_select_value('f_custom_fields', 'cf_name', array('id' => $i)), $GLOBALS['FORUM_DB']);
                $listing[] = array(
                    $cpf_name,
                    COMMANDR_FS_FILE,
                    strlen($cpf_value),
                    $member_data['m_join_time'],
                );
            }
        } elseif (count($meta_dir) == 2) {
            if ($meta_dir[1] != 'groups') {
                return false;
            }

            // List the member's usergroups
            $groups = $GLOBALS['FORUM_DRIVER']->get_members_groups($GLOBALS['FORUM_DRIVER']->get_member_from_username($meta_dir[0]));
            $group_names = $GLOBALS['FORUM_DRIVER']->get_usergroup_list();
            foreach ($groups as $group) {
                if (array_key_exists($group, $group_names)) {
                    $listing[] = array(
                        $group_names[$group],
                        COMMANDR_FS_FILE,
                        0,
                        null,
                    );
                }
            }
        } else {
            return false; // Directory doesn't exist
        }

        return $listing;
    }

    /**
     * Standard Commandr-fs directory creation function for commandr_fs hooks.
     *
     * @param  array $meta_dir The current meta-directory path
     * @param  string $meta_root_node The root node of the current meta-directory
     * @param  string $new_dir_name The new directory name
     * @param  object $commandr_fs A reference to the Commandr filesystem object
     * @return boolean Success?
     */
    public function make_directory($meta_dir, $meta_root_node, $new_dir_name, &$commandr_fs)
    {
        if (get_forum_type() != 'cns') {
            return false;
        }

        if (count($meta_dir) < 1) {
            // We're at the top level, and adding a new member
            require_code('cns_members_action');
            require_code('cns_members_action2');
            cns_make_member($new_dir_name, 'commandr', '', null, null, null, null, array(), null, null, 1, null, null, '', '', '', 0, 1, 1, '', '', '', 1, 1, null, 1, 1, null, '', false);
        } else {
            return false; // Directories aren't allowed to be added anywhere else
        }

        return true;
    }

    /**
     * Standard Commandr-fs directory removal function for commandr_fs hooks.
     *
     * @param  array $meta_dir The current meta-directory path
     * @param  string $meta_root_node The root node of the current meta-directory
     * @param  string $dir_name The directory name
     * @param  object $commandr_fs A reference to the Commandr filesystem object
     * @return boolean Success?
     */
    public function remove_directory($meta_dir, $meta_root_node, $dir_name, &$commandr_fs)
    {
        if (get_forum_type() != 'cns') {
            return false;
        }

        if (count($meta_dir) < 1) {
            // We're at the top level, and removing a member
            require_code('cns_members_action');
            require_code('cns_members_action2');
            cns_delete_member($GLOBALS['FORUM_DRIVER']->get_member_from_username($dir_name));
        } else {
            return false; // Directories aren't allowed to be removed anywhere else
        }

        return true;
    }

    /**
     * Standard Commandr-fs file removal function for commandr_fs hooks.
     *
     * @param  array $meta_dir The current meta-directory path
     * @param  string $meta_root_node The root node of the current meta-directory
     * @param  string $file_name The file name
     * @param  object $commandr_fs A reference to the Commandr filesystem object
     * @return boolean Success?
     */
    public function remove_file($meta_dir, $meta_root_node, $file_name, &$commandr_fs)
    {
        if (get_forum_type() != 'cns') {
            return false;
        }

        if (count($meta_dir) == 1) {
            // We're in a member's directory, and deleting one of their profile fields
            if (in_array($file_name, array(
                'id',
                'theme',
                'avatar',
                'validated',
                'timezone_offset',
                'primary_group',
                'signature',
                'banned',
                'preview_posts',
                'dob_day',
                'dob_month',
                'dob_year',
                'reveal_age',
                'e-mail',
                'title',
                'photo',
                'photo_thumb',
                'view_signatures',
                'auto_monitor_contrib_content',
                'language',
                'allow_e-mails',
                'notes',
                'wide',
                'max_attach_size'
            ))) {
                return false; // Can't delete a hard-coded (non-custom) profile field
            }

            require_code('cns_members_action');
            require_code('cns_members_action2');
            $field_id = $GLOBALS['FORUM_DB']->query_select_value_if_there('f_custom_fields', 'id', array($GLOBALS['FORUM_DB']->translate_field_ref('cf_name') => $file_name));
            if (is_null($field_id)) { // Should never happen, but sometimes on upgrades/corruption...
                $GLOBALS['FORUM_DRIVER']->install_create_custom_field($file_name, 10);
                $field_id = $GLOBALS['FORUM_DB']->query_select_value('f_custom_fields', 'id', array($GLOBALS['FORUM_DB']->translate_field_ref('cf_name') => $file_name));
            }

            cns_delete_custom_field($field_id);
        } elseif (count($meta_dir) == 2) {
            if ($meta_dir[1] != 'groups') {
                return false;
            }

            // We're in a member's usergroup directory, and removing them from a usergroup
            require_code('cns_groups_action');
            require_code('cns_groups_action2');
            $groups = $GLOBALS['FORUM_DRIVER']->get_usergroup_list();
            $group_id = array_search($file_name, $groups);
            if ($group_id !== false) {
                cns_member_leave_group($group_id, $GLOBALS['FORUM_DRIVER']->get_member_from_username($meta_dir[0]));
            } else {
                return false;
            }
        } else {
            return false; // Files shouldn't even exist anywhere else!
        }

        return true;
    }

    /**
     * Standard Commandr-fs file reading function for commandr_fs hooks.
     *
     * @param  array $meta_dir The current meta-directory path
     * @param  string $meta_root_node The root node of the current meta-directory
     * @param  string $file_name The file name
     * @param  object $commandr_fs A reference to the Commandr filesystem object
     * @return ~string The file contents (false: failure)
     */
    public function read_file($meta_dir, $meta_root_node, $file_name, &$commandr_fs)
    {
        if (get_forum_type() != 'cns') {
            return false;
        }

        if (count($meta_dir) == 1) {
            // We're in a member's directory, and reading one of their profile fields
            $coded_fields = array(
                'id' => 'id',
                'theme' => 'm_theme',
                'avatar' => 'm_avatar_url',
                'validated' => 'm_validated',
                'timezone_offset' => 'm_timezone_offset',
                'primary_group' => 'm_primary_group',
                'signature' => 'm_signature',
                'banned' => 'm_is_perm_banned',
                'preview_posts' => 'm_preview_posts',
                'dob_day' => 'm_dob_day',
                'dob_month' => 'm_dob_month',
                'dob_year' => 'm_dob_year',
                'reveal_age' => 'm_reveal_age',
                'e-mail' => 'm_email_address',
                'title' => 'm_title',
                'photo' => 'm_photo_url',
                'photo_thumb' => 'm_photo_thumb_url',
                'view_signatures' => 'm_views_signatures',
                'auto_monitor_contrib_content' => 'm_auto_monitor_contrib_content',
                'language' => 'm_language',
                'allow_e-mails' => 'm_allow_emails',
                'allow_e-mails_from_staff' => 'm_allow_emails_from_staff',
                'max_attach_size' => 'm_max_email_attach_size_mb'
            );
            if (array_key_exists($file_name, $coded_fields)) {
                return $GLOBALS['FORUM_DB']->query_select_value_if_there('f_members', $coded_fields[$file_name], array('id' => $GLOBALS['FORUM_DRIVER']->get_member_from_username($meta_dir[0])));
            }

            require_code('cns_members');
            $fields = cns_get_custom_fields_member($GLOBALS['FORUM_DRIVER']->get_member_from_username($meta_dir[0]));

            require_code('cns_members_action');
            require_code('cns_members_action2');
            $field_id = $GLOBALS['FORUM_DB']->query_select_value_if_there('f_custom_fields', 'id', array($GLOBALS['FORUM_DB']->translate_field_ref('cf_name') => $file_name));
            if (is_null($field_id)) { // Should never happen, but sometimes on upgrades/corruption...
                $GLOBALS['FORUM_DRIVER']->install_create_custom_field($file_name, 10);
                $field_id = $GLOBALS['FORUM_DB']->query_select_value('f_custom_fields', 'id', array($GLOBALS['FORUM_DB']->translate_field_ref('cf_name') => $file_name));
            }

            if (array_key_exists($field_id, $fields)) {
                return $fields[$field_id];
            } else {
                return false;
            }
        } elseif (count($meta_dir) == 2) {
            if ($meta_dir[1] != 'groups') {
                return false;
            }

            // We're in a member's usergroup directory, and all files should contain '1' :)
            return '1';
        }

        return false; // Files shouldn't even exist anywhere else!
    }

    /**
     * Standard Commandr-fs file writing function for commandr_fs hooks.
     *
     * @param  array $meta_dir The current meta-directory path
     * @param  string $meta_root_node The root node of the current meta-directory
     * @param  string $file_name The file name
     * @param  string $contents The new file contents
     * @param  object $commandr_fs A reference to the Commandr filesystem object
     * @return boolean Success?
     */
    public function write_file($meta_dir, $meta_root_node, $file_name, $contents, &$commandr_fs)
    {
        if (get_forum_type() != 'cns') {
            return false;
        }

        if (count($meta_dir) == 1) {
            // We're in a member's directory, and writing one of their profile fields
            $coded_fields = array(
                'id' => 'id',
                'theme' => 'm_theme',
                'avatar' => 'm_avatar_url',
                'validated' => 'm_validated',
                'timezone_offset' => 'm_timezone_offset',
                'primary_group' => 'm_primary_group',
                'signature' => 'm_signature',
                'banned' => 'm_is_perm_banned',
                'preview_posts' => 'm_preview_posts',
                'dob_day' => 'm_dob_day',
                'dob_month' => 'm_dob_month',
                'dob_year' => 'm_dob_year',
                'reveal_age' => 'm_reveal_age',
                'e-mail' => 'm_email_address',
                'title' => 'm_title',
                'photo' => 'm_photo_url',
                'photo_thumb' => 'm_photo_thumb_url',
                'view_signatures' => 'm_views_signatures',
                'auto_monitor_contrib_content' => 'm_auto_monitor_contrib_content',
                'language' => 'm_language',
                'allow_e-mails' => 'm_allow_emails',
                'allow_e-mails_from_staff' => 'm_allow_emails_from_staff',
                'max_attach_size' => 'm_max_email_attach_size_mb',
                'highlighted_name' => 'm_highlighted_name',
            );
            if (array_key_exists($file_name, $coded_fields)) {
                $GLOBALS['FORUM_DB']->query_update('f_members', array($coded_fields[$file_name] => $contents), array('id' => $GLOBALS['FORUM_DRIVER']->get_member_from_username($meta_dir[0])), '', 1);
                return true;
            }
            require_code('cns_members_action');
            require_code('cns_members_action2');
            $field_id = $GLOBALS['FORUM_DB']->query_select_value_if_there('f_custom_fields', 'id', array($GLOBALS['FORUM_DB']->translate_field_ref('cf_name') => $file_name));
            if (is_null($field_id)) { // Should never happen, but sometimes on upgrades/corruption...
                $GLOBALS['FORUM_DRIVER']->install_create_custom_field($file_name, 10);
                $field_id = $GLOBALS['FORUM_DB']->query_select_value_if_there('f_custom_fields', 'id', array($GLOBALS['FORUM_DB']->translate_field_ref('cf_name') => $file_name));
            }

            if (is_null($field_id)) {
                $field_id = cns_make_custom_field($file_name);
            }
            cns_set_custom_field($GLOBALS['FORUM_DRIVER']->get_member_from_username($meta_dir[0]), $field_id, $contents);
        } elseif (count($meta_dir) == 2) {
            if ($meta_dir[1] != 'groups') {
                return false;
            }

            // We're in a member's usergroup directory, and writing one of their usergroup associations
            require_code('cns_groups_action');
            require_code('cns_groups_action2');
            $groups = $GLOBALS['FORUM_DRIVER']->get_usergroup_list();
            $group_id = array_search($file_name, $groups);
            if ($group_id !== false) {
                cns_add_member_to_group($GLOBALS['FORUM_DRIVER']->get_member_from_username($meta_dir[0]), $group_id, 1);
            } else {
                return false;
            }
        } else {
            return false; // Group files can't be written, and other files shouldn't even exist anywhere else!
        }

        return true;
    }
}
