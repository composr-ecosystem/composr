<?php /*

 Composr
 Copyright (c) ocProducts, 2004-2020

 See text/EN/licence.txt for full licensing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

/**
 * @license    http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright  ocProducts Ltd
 * @package    cns_forum
 */

/**
 * Hook class.
 */
class Hook_commandr_scheduled_publish_post
{
    /**
     * Get information about this hook.
     *
     * @return array Map of hook details
     */
    public function info()
    {
        if (!addon_installed('cns_forum')) {
            return null;
        }

        return [
            'required_parameters' => 17,
        ];
    }

    /**
     * Run Commandr hook.
     *
     * @param  array $options The options with which the command was called
     * @param  string $id Unspecified identifier for the resource behind this scheduled event
     * @param  array $parameters The json_decoded parameters passed with run_scheduled_action
     * @param  object $commandr_fs A reference to the Commandr filesystem object
     * @return array Array of stdcommand, stdhtml, stdout, and stderr responses
     */
    public function run($options, $id, $parameters, &$commandr_fs)
    {
        // Map out parameters to make them easier to understand since there are many of them
        $topic_id = $parameters[0];
        $validated = $parameters[1];
        $open = $parameters[2];
        $pinned = $parameters[3];
        $cascading = $parameters[4];
        $new_title = $parameters[5];
        $to = $parameters[6];
        $forum_id = $parameters[7];
        $title = $parameters[8];
        $post = $parameters[9];
        $skip_sig = $parameters[10];
        $first_post = $parameters[11];
        $is_emphasised = $parameters[12];
        $poster_name_if_guest = $parameters[13];
        $intended_solely_for = $parameters[14];
        $topic_title = $parameters[15];
        $anonymous = $parameters[16];

        require_code('cns_topics_action2');
        require_code('cns_topics_action');

        cns_edit_topic($topic_id, null, null, $validated, $open, $pinned, $cascading, '', $new_title);
        if (($to != $forum_id) && ($to !== null)) {
            cns_move_topics($forum_id, $to, [$topic_id]);
        }

        $post_id = cns_make_post($topic_id, $title, $post, $skip_sig, $first_post, $validated, $is_emphasised, $poster_name_if_guest, null, null, null, $intended_solely_for, null, null, false, true, null, true, $topic_title, null, $anonymous == 1);
        if (addon_installed('awards')) {
            require_code('awards');
            handle_award_setting('post', strval($post_id));
        }

        return ['', '', do_lang('SUCCESS'), ''];
    }
}
