<?php /*

 Composr
 Copyright (c) Christopher Graham, 2004-2024

 See docs/LICENSE.md for full licensing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

/**
 * @license    http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright  Christopher Graham
 * @package    points
 */

/**
 * Standard code module initialisation function.
 *
 * @ignore
 */
function init__points_escrow()
{
    require_lang('points');

    // Define constants for escrow.status in the database
    if (!defined('ESCROW_STATUS_CANCELLED')) {
        define('ESCROW_STATUS_CANCELLED', 0);
    }
    if (!defined('ESCROW_STATUS_COMPLETED')) {
        define('ESCROW_STATUS_COMPLETED', 1);
    }
    if (!defined('ESCROW_STATUS_PENDING')) {
        define('ESCROW_STATUS_PENDING', 2);
    }
    if (!defined('ESCROW_STATUS_DISPUTED')) {
        define('ESCROW_STATUS_DISPUTED', 3);
    }
}

/**
 * Get a results table of the escrows between two members.
 *
 * @param  MEMBER $member_id_of Who we are looking at escrows for
 * @param  MEMBER $member_id_viewing Who we are looking at escrows using the account of
 * @return Tempcode The UI
 */
function points_get_escrow(int $member_id_of, int $member_id_viewing) : object
{
    $start = get_param_integer('escrow_start', 0);
    $max = get_param_integer('escrow_max', intval(get_option('point_logs_per_page')));
    $sortables = ['date_and_time' => do_lang_tempcode('DATE'), 'amount' => do_lang_tempcode('AMOUNT')];
    $test = explode(' ', get_param_string('escrow_sort', 'date_and_time DESC', INPUT_FILTER_GET_COMPLEX));
    if (count($test) == 1) {
        $test[1] = 'DESC';
    }
    list($sortable, $sort_order) = $test;
    if (((cms_strtoupper_ascii($sort_order) != 'ASC') && (cms_strtoupper_ascii($sort_order) != 'DESC')) || (!array_key_exists($sortable, $sortables))) {
        log_hack_attack_and_exit('ORDERBY_HACK');
    }

    if (($member_id_of == $member_id_viewing) || (has_privilege($member_id_viewing, 'moderate_points_escrow'))) {
        $where = ' AND (sending_member=' . strval($member_id_of) . ' OR receiving_member=' . strval($member_id_of) . ')';
    } else {
        $where = ' AND (sending_member=' . strval($member_id_of) . ' OR sending_member=' . strval($member_id_viewing) . ') AND (receiving_member=' . strval($member_id_of) . ' OR receiving_member=' . strval($member_id_viewing) . ')';
    }

    $max_rows = $GLOBALS['SITE_DB']->query_select_value('escrow', 'COUNT(*)', [], $where);
    if ($max_rows == 0) {
        return new Tempcode();
    }
    $rows = $GLOBALS['SITE_DB']->query_select('escrow', ['*'], [], $where . ' ORDER BY ' . $sortable . ' ' . $sort_order, $max, $start);

    $out = new Tempcode();

    $viewing_name = $GLOBALS['FORUM_DRIVER']->get_username($member_id_of, true);

    require_code('templates_results_table');

    $header_columns = [
        do_lang_tempcode('IDENTIFIER'),
        do_lang_tempcode('DATE'),
        do_lang_tempcode('AMOUNT'),
        do_lang_tempcode('SENDER'),
        do_lang_tempcode('RECIPIENT'),
        do_lang_tempcode('REASON')
    ];
    $header_row = results_header_row($header_columns, $sortables, 'escrow_sort', $sortable . ' ' . $sort_order, 'gbcaf8b021e3939bfce1dce9ff8ed63a', null, 'tab--points');

    foreach ($rows as $myrow) {
        // Their name
        $from_name = is_guest($myrow['sending_member']) ? get_site_name() : $GLOBALS['FORUM_DRIVER']->get_username($myrow['sending_member'], true);
        $to_name = (($myrow['receiving_member'] === null) || is_guest($myrow['receiving_member'])) ? do_lang('SYSTEM') : $GLOBALS['FORUM_DRIVER']->get_username($myrow['receiving_member'], true);
        $_from_name = is_guest($myrow['sending_member']) ? make_string_tempcode(escape_html($from_name)) : hyperlink(points_url($myrow['sending_member']), escape_html($from_name), false, false, do_lang_tempcode('VIEW_POINTS'));
        $_to_name = (($myrow['receiving_member'] === null) || is_guest($myrow['receiving_member'])) ? make_string_tempcode(escape_html($to_name)) : hyperlink(points_url($myrow['receiving_member']), escape_html($to_name), false, false, do_lang_tempcode('VIEW_POINTS'));

        $date = get_timezoned_date_time($myrow['date_and_time'], false);
        $_date = hyperlink(build_url(['page' => 'points', 'type' => 'view_escrow', 'id' => $myrow['id'], 'member_id_of' => $member_id_of], get_module_zone('points')), escape_html($date), false, false, do_lang_tempcode('ESCROW_VIEW'));

        $amount = $myrow['amount'];
        $reason = get_translated_tempcode('escrow', $myrow, 'reason');

        $results_entry = [
            strval($myrow['id']),
            $_date,
            integer_format($amount),
            $_from_name,
            $_to_name,
            $reason
        ];
        $out->attach(results_entry($results_entry, true));
    }
    return results_table(do_lang_tempcode('_ESCROW', escape_html($viewing_name)), $start, 'escrow_start', $max, 'escrow_max', $max_rows, $header_row, $out, $sortables, $sortable, $sort_order, 'escrow_sort', null, [], null, 8, 'gbcaf8b021e3939bfce1dce9ff8ed63a', false, 'tab--points');
}

/**
 * Get a results table of the logs for a provided escrow.
 *
 * @param  AUTO_LINK $id The ID of the escrow
 * @return Tempcode The UI
 */
function escrow_get_logs(int $id) : object
{
    require_code('templates_tooltip');

    $start = get_param_integer('start', 0);
    $max = get_param_integer('max', 50);
    $sortables = ['date_and_time' => do_lang_tempcode('DATE')];
    $test = explode(' ', get_param_string('sort', 'date_and_time DESC', INPUT_FILTER_GET_COMPLEX));
    if (count($test) == 1) {
        $test[1] = 'DESC';
    }
    list($sortable, $sort_order) = $test;
    if (((cms_strtoupper_ascii($sort_order) != 'ASC') && (cms_strtoupper_ascii($sort_order) != 'DESC')) || (!array_key_exists($sortable, $sortables))) {
        log_hack_attack_and_exit('ORDERBY_HACK');
    }

    $max_rows = $GLOBALS['SITE_DB']->query_select_value('escrow_logs', 'COUNT(*)', ['escrow_id' => $id]);
    if ($max_rows == 0) {
        return new Tempcode();
    }
    $rows = $GLOBALS['SITE_DB']->query_select('escrow_logs', ['*'], ['escrow_id' => $id], 'ORDER BY ' . $sortable . ' ' . $sort_order, $max, $start);
    $out = new Tempcode();

    require_code('templates_results_table');

    $header_columns = [
        do_lang_tempcode('DATE'),
        do_lang_tempcode('ACTION'),
        do_lang_tempcode('MEMBER'),
        do_lang_tempcode('ADDITIONAL_INFO')
    ];
    $header_row = results_header_row($header_columns, $sortables, 'sort', $sortable . ' ' . $sort_order);

    foreach ($rows as $myrow) {
        // Their name
        if ($myrow['member_id'] !== null) {
            $_name = is_guest($myrow['member_id']) ? do_lang('SYSTEM') : $GLOBALS['FORUM_DRIVER']->get_username($myrow['member_id'], true);
            $name = (is_guest($myrow['member_id'])) ? make_string_tempcode(escape_html($_name)) : hyperlink(points_url($myrow['member_id']), escape_html($_name), false, false, do_lang_tempcode('VIEW_POINTS'));
        }

        $date = get_timezoned_date_time($myrow['date_and_time'], false);

        $reason = get_translated_tempcode('escrow_logs', $myrow, 'information');

        $results_entry = [
            $date,
            do_lang_tempcode($myrow['log_type']),
            ($myrow['member_id'] !== null) ? $name : '',
            protect_from_escaping(generate_truncation($reason, 'left', 200, true, true))
        ];

        $out->attach(results_entry($results_entry, true));
    }
    return results_table(do_lang_tempcode('ESCROW_LOGS'), $start, 'start', $max, 'max', $max_rows, $header_row, $out, $sortables, $sortable, $sort_order, 'sort', null, [], null, 8, 'gbcaf8b021e3939bfce1dce9ff8ed63a', false, null, false, false);
}

/**
 * Create a new points escrow between two members.
 *
 * @param  MEMBER $sending_member The member creating and putting the points into escrow
 * @param  ?MEMBER $receiving_member The member who will receive the points once the escrow conditions are met (null: system because we do not know who will receive these points yet)
 * @param  integer $amount The amount of points to escrow
 * @param  SHORT_TEXT $reason The reason for escrow used in logs
 * @param  LONG_TEXT $agreement The detailed terms and conditions for the escrow
 * @param  ?TIME $expiry_time The time this escrow will automatically cancel or enter dispute if the terms are not met (null: do not automatically expire)
 * @param  ID_TEXT $content_type The associated content type with this escrow (blank: none)
 * @param  ID_TEXT $content_id The associated content ID with this escrow (blank: none)
 * @param  boolean $escrow_log Whether to log the escrow creation in its own log
 * @param  ?boolean $send_notifications Whether to send notifications for this transaction (false: only the staff get it) (true: both the member and staff get it) (null: neither the member nor staff get it)
 * @return ?AUTO_LINK The ID of the escrow record (null: There was an error)
 */
function escrow_points(int $sending_member, ?int $receiving_member, int $amount, string $reason, string $agreement, ?int $expiry_time = null, string $content_type = '', string $content_id = '', bool $escrow_log = true, ?bool $send_notifications = true) : ?int
{
    if (is_guest($sending_member) || (($receiving_member !== null) && (is_guest($receiving_member)))) { // We can escrow to guest, but not from guest
        return null;
    }
    if ($amount <= 0) {
        return null;
    }

    if ($receiving_member === null) {
        $username = do_lang('SYSTEM');
    } else {
        $username = $GLOBALS['FORUM_DRIVER']->get_username($receiving_member, true, USERNAME_GUEST_AS_DEFAULT);
    }

    require_code('points2');

    // Actually debit the points into escrow (do not allow using gift points as escrows since escrows are for transactions, not gifts)
    $escrow_id = points_debit_member($sending_member, do_lang('ESCROW_REASON', $username, $reason), $amount, 0, 0, $send_notifications, 0, 'points_escrow', 'add');
    if ($escrow_id === null) {
        return null;
    }

    // Insert the escrow into the database
    $map = [
        'date_and_time' => time(),
        'update_date_and_time' => time(),
        'amount' => $amount,
        'original_points_ledger_id' => $escrow_id,
        'sending_member' => $sending_member,
        'receiving_member' => $receiving_member,
        'expiration_time' => $expiry_time,
        'sender_status' => 0,
        'recipient_status' => 0,
        'status' => ESCROW_STATUS_PENDING,
        'content_type' => $content_type,
        'content_id' => $content_id,
    ];
    $map += insert_lang_comcode('reason', $reason, 4);
    $map += insert_lang_comcode('agreement', $agreement, 5);
    $id = $GLOBALS['SITE_DB']->query_insert('escrow', $map, true);
    $GLOBALS['SITE_DB']->query_update('points_ledger', ['t_type' => 'points_escrow', 't_subtype' => 'add', 't_type_id' => strval($id)], ['id' => $escrow_id], '', 1);

    // Log it
    if ($escrow_log) {
        escrow_log_it('LOG_ESCROW_CREATED', $id, $sending_member, $agreement);
    }
    log_it('LOG_ESCROW_CREATED', strval($id), $username);

    // Dispatch notification
    require_code('notifications');
    if ($send_notifications !== null) {
        $link_comcode = '[page="_SEARCH:points:view_escrow:' . comcode_escape(strval($id)) . '"]' . comcode_escape($reason) . '[/page]';
        $map = [
            '_GUID' => '1225d89038254b979fe8068a57766e0e',
            'ID' => strval($id),
            'INTRO' => do_lang_tempcode('NEW_ESCROW_TRANSACTION_INTRO', $link_comcode),
            'ESCROW_FROM' => strval($sending_member),
            'AMOUNT' => integer_format($amount),
            'REASON' => $reason,
            'TERMS' => $agreement,
        ];
        if ($receiving_member !== null) {
            $map['ESCROW_TO'] = strval($receiving_member);
        }
        if ($expiry_time !== null) {
            $map['EXPIRATION'] = strval($expiry_time);
        }
        if (($content_type != '')) {
            if (($content_id != '')) {
                require_code('content');
                list($title, , , , , $mail_url) = content_get_details($content_type, $content_id);
                if ($title !== null) {
                    $map['CONTENT_TITLE'] = $title;
                    $map['CONTENT_URL'] = $mail_url;
                }
            } else {
                $map['CONTENT_TYPE'] = $content_type;
            }
        }

        // Involved members
        if (($send_notifications) && ($receiving_member !== null)) {
            $subject = do_lang_tempcode('NEW_ESCROW_TRANSACTION_SUBJECT', $reason);
            $mail = do_notification_template('ESCROW_TRANSACTIONS_MAIL', $map, get_lang($receiving_member), false, null, '.txt', 'text');
            dispatch_notification('point_escrows', null, $subject->evaluate(get_lang($receiving_member)), $mail->evaluate(get_lang($receiving_member)), [$receiving_member], $sending_member);
        }

        // Staff
        $subject = do_lang_tempcode('NEW_ESCROW_TRANSACTION_SUBJECT_STAFF', $reason);
        $map['INTRO'] = do_lang_tempcode('NEW_ESCROW_TRANSACTION_INTRO_STAFF', $link_comcode);
        $mail = do_notification_template('ESCROW_TRANSACTIONS_MAIL', $map, null, false, null, '.txt', 'text');
        dispatch_notification('point_escrows_staff_passive', null, $subject->evaluate(get_site_default_lang()), $mail->evaluate(get_site_default_lang()), null, $sending_member);
    }

    return $id;
}

/**
 * Mark an escrow as satisfied by a member. Also completes the escrow if both members satisfied.
 *
 * @param  AUTO_LINK $id The ID of the escrow to satisfy
 * @param  MEMBER $member_id The member who is satisfying it
 * @param  ?array $row If the escrow was already queried from the database, this is the row (null: query for the escrow)
 * @param  boolean $escrow_log Whether to log this in the escrow logs
 * @param  ?boolean $send_notifications Whether to send notifications for this transaction (false: only the staff get it) (true: both the member and staff get it) (null: neither the member nor staff get it)
 * @return ?array Tuple [integer ID of the recipient ledger, ?integer ID of the ledger refunding the sender (null means no refund processed), ?integer total points refunded (null means no refund), ?integer number of refunded points that were gift points (null means no refund)] (null: the escrow was not yet fully satisfied by all members)
 */
function satisfy_escrow(int $id, int $member_id, ?array $row = null, bool $escrow_log = true, ?bool $send_notifications = true) : ?array
{
    if ($row === null) {
        $_row = $GLOBALS['SITE_DB']->query_select('escrow', ['*'], ['id' => $id], '', 1);
        if ($_row === null || !array_key_exists(0, $_row)) {
            warn_exit(do_lang_tempcode('MISSING_RESOURCE'));
        }
        $row = $_row[0];
    }

    // Cannot mark an escrow satisfied if it is not active
    if (($row['status'] < ESCROW_STATUS_PENDING)) {
        warn_exit(do_lang_tempcode('INTERNAL_ERROR', escape_html('f647821bd42455369edd89aadcd70a68')));
    }

    // Cannot mark an escrow satisfied if we still do not know to whom the points are going
    if ($row['receiving_member'] === null) {
        warn_exit(do_lang_tempcode('INTERNAL_ERROR', escape_html('9e3c3042ad33526eb3f2f090230ef5c2')));
    }

    // Mark the escrow satisfied
    $map = ['update_date_and_time' => time()];
    if ($row['sending_member'] == $member_id) {
        $map['sender_status'] = 1;
    } elseif ($row['receiving_member'] === $member_id) {
        $map['recipient_status'] = 1;
    } else { // This should never happen!
        warn_exit(do_lang_tempcode('INTERNAL_ERROR', escape_html('a3f36917d20d51b7a805f82c27126883')));
    }
    $GLOBALS['SITE_DB']->query_update('escrow', $map, ['id' => $id], '', 1);

    $username = $GLOBALS['FORUM_DRIVER']->get_username($member_id, true, USERNAME_GUEST_AS_DEFAULT | USERNAME_DEFAULT_ERROR);

    // Log it
    if ($escrow_log) {
        escrow_log_it('LOG_ESCROW_SATISFIED', $id, $member_id);
    }
    log_it('LOG_ESCROW_SATISFIED', strval($id), $username);

    // If both members satisfied the escrow, then complete it
    $finished = @intval($GLOBALS['SITE_DB']->query_select_value('escrow', 'sender_status+recipient_status', ['id' => $id]));
    if ($finished === 2) {
        return _complete_escrow($row, null, $escrow_log, $send_notifications);
    }
    return null;
}

/**
 * The actualiser for completing an escrow and crediting the points to the recipient. Also returns points to the sender if we are not crediting the full amount.
 *
 * @param  array $row The database row for the escrow to mark complete
 * @param  ?integer $amount The number of points to credit to the recipient; the rest will be refunded to the sender (null: credit the full amount from the escrow)
 * @param  boolean $escrow_log Whether to log this in the escrow logs
 * @param  ?boolean $send_notifications Whether to send notifications for this transaction (false: only the staff get it) (true: both the member and staff get it) (null: neither the member nor staff get it)
 * @return array Tuple [integer ID of the recipient ledger, ?integer ID of the ledger refunding the sender (null means no refund processed), ?integer total points refunded (null means no refund), ?integer number of refunded points that were gift points (null means no refund)]
 */
function _complete_escrow(array $row, ?int $amount = null, bool $escrow_log = true, ?bool $send_notifications = true) : array
{
    if ($amount !== null && $amount <= 0) {
        warn_exit(do_lang_tempcode('INTERNAL_ERROR', escape_html('14d5918767855124a26bb7d5381553f0')));
    }
    if ($amount === null || $amount > $row['amount']) {
        $amount = $row['amount'];
    }

    $response = [];

    require_code('points2');

    $id = $row['id'];
    $sending_member = $row['sending_member'];
    $receiving_member = $row['receiving_member'];
    $content_type = $row['content_type'];
    $content_id = $row['content_id'];
    $reason = get_translated_text($row['reason']);

    if ($receiving_member === null) {
        warn_exit(do_lang_tempcode('INTERNAL_ERROR', escape_html('9a3e932b33f35d169204675e6e91e9a0')));
    }

    $username = $GLOBALS['FORUM_DRIVER']->get_username($sending_member, true, USERNAME_GUEST_AS_DEFAULT | USERNAME_DEFAULT_ERROR);

    // Update the escrow status
    $GLOBALS['SITE_DB']->query_update('escrow', ['status' => ESCROW_STATUS_COMPLETED, 'update_date_and_time' => time()], ['id' => $id], '', 1);

    // Credit the points to the recipient in a new transaction
    $_id = points_credit_member($receiving_member, do_lang('ESCROW_REASON_FROM', $username, $reason), $amount, 0, null, 0, 'points_escrow', 'complete', strval($id));
    $response[] = $_id;

    // If we are not crediting the recipient with the full escrow points, then we need to refund the rest to the sender
    if ($amount < $row['amount']) {
        $_ledger = $GLOBALS['SITE_DB']->query_select('points_ledger', ['*'], ['id' => $row['original_points_ledger_id']], '', 1);
        if ($_ledger === null || !array_key_exists(0, $_ledger)) {
            warn_exit(do_lang_tempcode('MISSING_RESOURCE'));
        }
        $ledger = $_ledger[0];

        $refund = ($row['amount'] - $amount);
        $refund_gift_points = min($refund, $ledger['amount_gift_points']);

        $id_b = points_refund($GLOBALS['FORUM_DRIVER']->get_guest_id(), $row['sending_member'], do_lang('ESCROW_REASON_FROM', $username, $reason), $amount, $refund_gift_points, 0, $ledger, null, 'points_escrow', 'refund', strval($id), null, LEDGER_STATUS_REFUND);
        $response[] = $id_b;
        $response[] = $refund;
        $response[] = $refund_gift_points;

        // Also, edit the points amount on the escrow itself; we especially need to know this for accurate stats
        $GLOBALS['SITE_DB']->query_update('escrow', ['amount' => $amount, 'update_date_and_time' => time()], ['id' => $id], '', 1);
    }

    // Log it
    if ($escrow_log) {
        escrow_log_it('LOG_ESCROW_COMPLETED', $id, null, do_lang('NOTIFICATION_POINTS_TRANSACTION_POINTS_L', integer_format($amount)));
    }
    log_it('LOG_ESCROW_COMPLETED', strval($id), do_lang('NOTIFICATION_POINTS_TRANSACTION_POINTS_L', integer_format($amount)));

    if ($send_notifications !== null) {
        // Process notifications
        require_code('notifications');

        $map = [
            '_GUID' => 'ffcc0e59fb7040308076826f8d1307d6',
            'ID' => strval($id),
            'ESCROW_FROM' => strval($sending_member),
            'ESCROW_TO' => strval($receiving_member),
            'AMOUNT' => integer_format($amount),
            'REASON' => $reason,
        ];
        if (($content_type != '')) {
            if (($content_id != '')) {
                require_code('content');
                list($title, , , , , $mail_url) = content_get_details($content_type, $content_id);
                if ($title !== null) {
                    $map['CONTENT_TITLE'] = $title;
                    $map['CONTENT_URL'] = $mail_url;
                }
            } else {
                $map['CONTENT_TYPE'] = $content_type;
            }
        }

        // Involved members
        if ($send_notifications) {
            $notification_members = [$sending_member, $receiving_member];
            $subject = do_lang_tempcode('ESCROW_FULLY_SATISFIED_SUBJECT', $reason);
            foreach ($notification_members as $n_member) {
                $mail = do_notification_template('ESCROW_FULLY_SATISFIED_MAIL', $map, get_lang($n_member), false, null, '.txt', 'text');
                dispatch_notification('point_escrows', null, $subject->evaluate(get_lang($n_member)), $mail->evaluate(get_lang($n_member)), [$n_member], A_FROM_SYSTEM_UNPRIVILEGED);
            }
        }

        // Staff
        $subject = do_lang_tempcode('ESCROW_FULLY_SATISFIED_SUBJECT', $reason);
        $mail = do_notification_template('ESCROW_FULLY_SATISFIED_MAIL', $map, null, false, null, '.txt', 'text');
        dispatch_notification('point_escrows_staff_passive', null, $subject->evaluate(get_site_default_lang()), $mail->evaluate(get_site_default_lang()), null, A_FROM_SYSTEM_UNPRIVILEGED);
    }

    return $response;
}

/**
 * Cancel an escrow, refunding the points and sending out a notification.
 *
 * @param  AUTO_LINK $id The ID of the escrow to cancel
 * @param  MEMBER $member_id The member cancelling the escrow (use guest for system)
 * @param  LONG_TEXT $reason The explanation for cancelling the escrow
 * @param  ?array $row The database row for the escrow (null: query for it)
 * @param  boolean $actually_refund Whether to actually refund the points to the sender (this should be false if the original points transaction is being reversed)
 * @return ?AUTO_LINK The ID of the points_ledger transaction refunding the points to the sender (null: the refund was not processed)
 */
function cancel_escrow(int $id, int $member_id, string $reason, ?array $row = null, bool $actually_refund = true) : ?int
{
    if ($row === null) {
        $_row = $GLOBALS['SITE_DB']->query_select('escrow', ['*'], ['id' => $id], '', 1);
        if ($_row === null || !array_key_exists(0, $_row)) {
            warn_exit(do_lang_tempcode('MISSING_RESOURCE'));
        }
        $row = $_row[0];
    }

    // Cannot mark an escrow cancelled if it is not active
    if (($row['status'] < ESCROW_STATUS_PENDING)) {
        warn_exit(do_lang_tempcode('INTERNAL_ERROR', escape_html('0012c75e086155e69e2f56b0b3701402')));
    }

    $escrow_reason = get_translated_tempcode('escrow', $row, 'reason');
    $username = $GLOBALS['FORUM_DRIVER']->get_username($member_id, true, USERNAME_GUEST_AS_DEFAULT);

    // Update status
    $GLOBALS['SITE_DB']->query_update('escrow', ['status' => ESCROW_STATUS_CANCELLED, 'update_date_and_time' => time()], ['id' => $id], '', 1);

    $refund_id = null;
    if ($actually_refund) {
        // Get the original points ledger
        $_ledger = $GLOBALS['SITE_DB']->query_select('points_ledger', ['id', 'amount_gift_points'], ['id' => $row['original_points_ledger_id']], '', 1);
        if ($_ledger === null || !array_key_exists(0, $_ledger)) {
            warn_exit(do_lang_tempcode('MISSING_RESOURCE'));
        }
        $ledger = $_ledger[0];

        // Refund points to the sender
        require_code('points2');
        $_reason = do_lang_tempcode('ESCROW_REASON_CANCELLED', $escrow_reason);
        $refund_id = points_refund($GLOBALS['FORUM_DRIVER']->get_guest_id(), $row['sending_member'], $_reason->evaluate(), $row['amount'], $ledger['amount_gift_points'], 0, $ledger, true, 'points_escrow', 'cancel', strval($id));
    }

    // Log it
    escrow_log_it('LOG_ESCROW_CANCELLED', $id, $member_id, $reason);
    log_it('LOG_ESCROW_CANCELLED', strval($id), $username);

    // Send out a notification
    require_code('notifications');

    $subject = do_lang_tempcode('ESCROW_CANCELLED_SUBJECT', $escrow_reason);
    $map = [
        '_GUID' => '9981b4baa98547ad9a2571e5b2464c91',
        'ID' => strval($id),
        'ESCROW_REASON' => $escrow_reason,
        'CANCELLING_MEMBER' => strval($member_id),
        'REASON' => $reason,
    ];

    // Involved members
    $notification_members = [$row['sending_member']];
    if ($row['receiving_member'] !== null) {
        $notification_members[] = $row['receiving_member'];
    }
    foreach ($notification_members as $n_member) {
        $mail = do_notification_template('ESCROW_CANCELLED_MAIL', $map, get_lang($n_member), false, null, '.txt', 'text');
        dispatch_notification('point_escrows', null, $subject->evaluate(get_lang($n_member)), $mail->evaluate(get_lang($n_member)), [$n_member], $member_id);
    }

    // Staff
    $mail = do_notification_template('ESCROW_CANCELLED_MAIL', $map, null, false, null, '.txt', 'text');
    dispatch_notification('point_escrows_staff_passive', null, $subject->evaluate(get_site_default_lang()), $mail->evaluate(get_site_default_lang()), null, $member_id);

    return $refund_id;
}

/**
 * Mark an escrow as disputed, and send out notifications.
 *
 * @param  AUTO_LINK $id The ID of the escrow being disputed
 * @param  MEMBER $member_id The member disputing the escrow (use guest for system)
 * @param  LONG_TEXT $reason The reason / message for the dispute
 * @param  ?array $row The database row for the escrow (null: query it)
 */
function dispute_escrow(int $id, int $member_id, string $reason, ?array $row = null) : void
{
    if ($row === null) {
        $_row = $GLOBALS['SITE_DB']->query_select('escrow', ['*'], ['id' => $id], '', 1);
        if ($_row === null || !array_key_exists(0, $_row)) {
            warn_exit(do_lang_tempcode('MISSING_RESOURCE'));
        }
        $row = $_row[0];
    }

    // Cannot dispute a non-active escrow
    if ($row['status'] < ESCROW_STATUS_PENDING) {
        warn_exit(do_lang_tempcode('INTERNAL_ERROR', escape_html('50c7d608364b59eca6fd26a04ee244b7')));
    }

    $escrow = get_translated_tempcode('escrow', $row, 'reason');
    $username = $GLOBALS['FORUM_DRIVER']->get_username($member_id, true, USERNAME_GUEST_AS_DEFAULT);

    // Update status
    $GLOBALS['SITE_DB']->query_update('escrow', ['status' => ESCROW_STATUS_DISPUTED, 'update_date_and_time' => time()], ['id' => $id], '', 1);

    // Log it
    escrow_log_it('LOG_ESCROW_DISPUTED', $id, $member_id, $reason);
    log_it('LOG_ESCROW_DISPUTED', strval($id), $username);

    // Send out a notification to staff
    require_code('notifications');
    $subject = do_lang_tempcode('ESCROW_DISPUTED_SUBJECT', $escrow);
    $map = [
        '_GUID' => '9981b4baa98547ad9a2571e5b2464c91',
        'ID' => strval($id),
        'ESCROW_REASON' => $escrow,
        'DISPUTING_MEMBER' => strval($member_id),
        'REASON' => $reason,
    ];
    $mail = do_notification_template('ESCROW_DISPUTED_MAIL', $map, null, false, null, '.txt', 'text');
    dispatch_notification('point_escrows_staff_active', null, $subject->evaluate(get_site_default_lang()), $mail->evaluate(get_site_default_lang()), null, $member_id);
}

/**
 * Moderate an escrow, and send out notifications.
 *
 * @param  AUTO_LINK $id The ID of the escrow to moderate
 * @param  MEMBER $member_id The member applying the dispute resolution action
 * @param  ID_TEXT $action The action to take
 * @set amend complete cancel
 * @param  LONG_TEXT $new_reason The new reason for the escrow
 * @param  LONG_TEXT $new_agreement The new agreement terms for the escrow
 * @param  integer $points The number of points to credit to the recipient (only applicable for the 'complete' action)
 * @param  LONG_TEXT $reason The explanation for the action taken to resolve this dispute
 * @param  ?array $row The database row for the escrow (null: query for it)
 */
function moderate_escrow(int $id, int $member_id, string $action, string $new_reason, string $new_agreement, int $points, string $reason, ?array $row = null) : void
{
    if ($row === null) {
        $_row = $GLOBALS['SITE_DB']->query_select('escrow', ['*'], ['id' => $id], '', 1);
        if ($_row === null || !array_key_exists(0, $_row)) {
            warn_exit(do_lang_tempcode('MISSING_RESOURCE'));
        }
        $row = $_row[0];
    }

    // Invalid action
    if (!in_array($action, ['amend', 'complete', 'cancel'])) {
        warn_exit(do_lang_tempcode('INTERNAL_ERROR', escape_html('cafb3c5440975f0ba6b19db4871199be')));
    }

    $escrow_reason = get_translated_tempcode('escrow', $row, 'reason');
    $username = $GLOBALS['FORUM_DRIVER']->get_username($member_id, true, USERNAME_GUEST_AS_DEFAULT);

    // Modify reason and agreement text
    $map = ['update_date_and_time' => time()];
    $map += lang_remap_comcode('reason', $row['reason'], $new_reason);
    $map += lang_remap_comcode('agreement', $row['agreement'], $new_agreement);

    $GLOBALS['SITE_DB']->query_update('escrow', $map, ['id' => $id], '', 1);

    // Do not proceed further if the escrow is not active
    if ($row['status'] < ESCROW_STATUS_PENDING) {
        escrow_log_it('LOG_ESCROW_AMENDED', $id, $member_id, $reason);
        log_it('LOG_ESCROW_AMENDED', strval($id), $username);
        return;
    }

    require_code('notifications');
    require_code('points2');

    // Perform action (edit action does nothing else)
    switch ($action) {
        case 'cancel':
            cancel_escrow($id, $member_id, $reason, $row);
            break;
        case 'complete':
            // Log it
            escrow_log_it('LOG_ESCROW_AMENDED', $id, $member_id, $reason);
            log_it('LOG_ESCROW_AMENDED', strval($id), $username);

            // Complete the escrow
            $data = _complete_escrow($row, $points, true, null);
            $points_refunded = ((array_key_exists(1, $data)) && (array_key_exists(2, $data))) ? ($data[2] - $data[1]) : 0;
            $gift_points_refunded = array_key_exists(2, $data) ? $data[2] : 0;

            // Send out a notification
            $subject = do_lang_tempcode('ESCROW_AMENDED_SUBJECT', $escrow_reason);
            $map = [
                '_GUID' => '9981b4baa98547ad9a2571e5b2464c91',
                'ID' => strval($id),
                'ESCROW_REASON' => $escrow_reason,
                'MODERATING_MEMBER' => strval($member_id),
                'POINTS_RECEIVED' => integer_format($points),
                'SENDER' => strval($row['sending_member']),
                'POINTS_REFUNDED' => integer_format($points_refunded),
                'GIFT_POINTS_REFUNDED' => integer_format($gift_points_refunded),
                'REASON' => $reason,
            ];
            if ($row['receiving_member'] !== null) {
                $map['RECIPIENT'] = strval($row['receiving_member']);
            }
            if (($row['content_type'] != '')) {
                if (($row['content_id'] != '')) {
                    require_code('content');
                    list($title, , , , , $mail_url) = content_get_details($row['content_type'], $row['content_id']);
                    if ($title !== null) {
                        $map['CONTENT_TITLE'] = $title;
                        $map['CONTENT_URL'] = $mail_url;
                    }
                } else {
                    $map['CONTENT_TYPE'] = $row['content_type'];
                }
            }

            // Involved members
            $notification_members = [$row['sending_member']];
            if ($row['receiving_member'] !== null) {
                $notification_members[] = $row['receiving_member'];
            }
            foreach ($notification_members as $n_member) {
                $mail = do_notification_template('ESCROW_AMENDED_MAIL', $map, get_lang($n_member), false, null, '.txt', 'text');
                dispatch_notification('point_escrows', null, $subject->evaluate(get_lang($n_member)), $mail->evaluate(get_lang($n_member)), [$n_member], $member_id);
            }

            // Staff
            $mail = do_notification_template('ESCROW_AMENDED_MAIL', $map, null, false, null, '.txt', 'text');
            dispatch_notification('point_escrows_staff_passive', null, $subject->evaluate(get_site_default_lang()), $mail->evaluate(get_site_default_lang()), null, $member_id);
            break;
        case 'amend':
            // Log it
            escrow_log_it('LOG_ESCROW_AMENDED', $id, $member_id, $reason);
            log_it('LOG_ESCROW_AMENDED', strval($id), $username);

            // Send out a notification
            $subject = do_lang_tempcode('ESCROW_AMENDED_SUBJECT', $escrow_reason);
            $map = [
                '_GUID' => '9981b4baa98547ad9a2571e5b2464c91',
                'ID' => strval($id),
                'ESCROW_REASON' => $escrow_reason,
                'MODERATING_MEMBER' => strval($member_id),
                'REASON' => $reason,
            ];

            // Involved members
            $notification_members = [$row['sending_member']];
            if ($row['receiving_member'] !== null) {
                $notification_members[] = $row['receiving_member'];
            }
            foreach ($notification_members as $n_member) {
                $mail = do_notification_template('ESCROW_AMENDED_MAIL', $map, get_lang($n_member), false, null, '.txt', 'text');
                dispatch_notification('point_escrows', null, $subject->evaluate(get_lang($n_member)), $mail->evaluate(get_lang($n_member)), [$n_member], $member_id);
            }

            // Staff
            $mail = do_notification_template('ESCROW_AMENDED_MAIL', $map, null, false, null, '.txt', 'text');
            dispatch_notification('point_escrows_staff_passive', null, $subject->evaluate(get_site_default_lang()), $mail->evaluate(get_site_default_lang()), null, $member_id);
            break;
    }
}

/**
 * Log something in a points escrow.
 *
 * @param  ID_TEXT $type The type of log; a language string
 * @param  AUTO_LINK $id The ID of the escrow
 * @param  ?MEMBER $member_id The member associated with this log (null: no member associated)
 * @param  LONG_TEXT $information Additional information pertaining to this log
 * @return AUTO_LINK The ID of the record
 */
function escrow_log_it(string $type, int $id, ?int $member_id = null, string $information = '') : int
{
    $map = [
        'escrow_id' => $id,
        'date_and_time' => time(),
        'log_type' => $type,
        'member_id' => $member_id
    ];
    $map += insert_lang_comcode('information', $information, 5);

    // Update timestamp on the escrow
    $GLOBALS['SITE_DB']->query_update('escrow', ['update_date_and_time' => time()], ['id' => $id], '', 1);

    return $GLOBALS['SITE_DB']->query_insert('escrow_logs', $map, true);
}

/**
 * Update (and log) the receiving member of an escrow.
 * This assumes the receiving member is set to null; if not, this will error.
 *
 * @param  AUTO_LINK $id The ID of the escrow to edit
 * @param  MEMBER $receiving_member The member to set as the receiving member
 */
function escrow_update_receiving_member(int $id, int $receiving_member)
{
    $_row = $GLOBALS['SITE_DB']->query_select('escrow', ['*'], ['id' => $id], '', 1);
    if ($_row === null || !array_key_exists(0, $_row)) {
        warn_exit(do_lang_tempcode('MISSING_RESOURCE'));
    }
    $row = $_row[0];

    if ($row['receiving_member'] !== null) {
        warn_exit(do_lang_tempcode('INTERNAL_ERROR', escape_html('4e7a457978d05b5c95121a14671c3486')));
    }

    $GLOBALS['SITE_DB']->query_update('escrow', ['update_date_and_time' => time(), 'receiving_member' => $receiving_member], ['id' => $id], '', 1);

    escrow_log_it('LOG_ESCROW_UPDATED_RECEIVING_MEMBER', $id, $receiving_member);
    log_it('LOG_ESCROW_UPDATED_RECEIVING_MEMBER', strval($id));
}

/**
 * Cancel all escrows associated with the given content type and ID.
 *
 * @param  ID_TEXT $content_type The content type to search
 * @param  ID_TEXT $content_id The content ID to search
 * @param  LONG_TEXT $reason The reason for cencelling these escrows
 * @return array Array of AUTO_LINK escrow IDs cancelled mapped to their ?AUTO_LINK point ledger
 */
function cancel_all_escrows_by_content(string $content_type, string $content_id, string $reason) : array
{
    if (($content_type == '') || ($content_id == '')) { // These cannot be blank
        warn_exit(do_lang('INTERNAL_ERROR', comcode_escape('7291be14516f59cab614d1cec15c7d75')));
    }

    $ret = [];

    $to_cancel = $GLOBALS['SITE_DB']->query_select('escrow', ['*'], ['content_type' => $content_type, 'content_id' => $content_id], ' AND status>=2');
    foreach ($to_cancel as $row) {
        $ret[$row['id']] = cancel_escrow($row['id'], get_member(), $reason, $row);
    }

    return $ret;
}

/**
 * Complete all escrows by a given content type and ID.
 * This bypasses the satisfy system. It will only complete escrows in the pending state.
 *
 * @param  MEMBER $receiving_member The member receiving the points for escrows without a receiving member set
 * @param  ID_TEXT $content_type The associated content type to complete
 * @param  ID_TEXT $content_id The associated content ID to complete
 * @return array Map of escrow IDs to the output of _complete_escrow()
 */
function complete_all_escrows_by_content(int $receiving_member, string $content_type, string $content_id) : array
{
    if (($content_type == '') || ($content_id == '')) { // These cannot be blank
        warn_exit(do_lang('INTERNAL_ERROR', comcode_escape('aab15df46ada52418e6388049e299e33')));
    }

    $ret = [];

    // Set all associated escrows without a receiving member to the specified one
    $GLOBALS['SITE_DB']->query_update('escrow', ['receiving_member' => $receiving_member], ['receiving_member' => null, 'content_type' => $content_type, 'content_id' => $content_id]);

    // Satisfy all associated escrows, but only the pending ones
    $to_satisfy = $GLOBALS['SITE_DB']->query_select('escrow', ['*'], ['content_type' => $content_type, 'content_id' => $content_id, 'status' => ESCROW_STATUS_PENDING]);
    foreach ($to_satisfy as $row) {
        $ret[$row['id']] = array_merge(_complete_escrow($row), ['amount' => $row['amount']]);
    }

    return $ret;
}
