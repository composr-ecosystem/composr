<?php /*

 Composr
 Copyright (c) Christopher Graham, 2004-2024

 See docs/LICENSE.md for full licensing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

/**
 * @license    http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright  ocProducts Ltd
 * @package    core_cns
 */

/**
 * Validate a post.
 *
 * @param  AUTO_LINK $post_id The ID of the post
 * @param  ?AUTO_LINK $topic_id The ID of the topic that contains the post (null: find out from the DB)
 * @param  ?AUTO_LINK $forum_id The forum that the topic containing the post is in (null: find out from the DB)
 * @param  ?MEMBER $poster The member that made the post being validated (null: find out from the DB)
 * @param  ?LONG_TEXT $post The post, in Comcode format (null: It'll have to be looked-up)
 * @return AUTO_LINK The ID of the topic (while this could be known without calling this function, as we've gone to effort and grabbed it from the DB, it might turn out useful for something)
 */
function cns_validate_post(int $post_id, ?int $topic_id = null, ?int $forum_id = null, ?int $poster = null, ?string $post = null) : int
{
    require_code('submit');

    $post_info = $GLOBALS['FORUM_DB']->query_select('f_posts', ['*'], ['id' => $post_id], '', 1);
    if ($topic_id === null) {
        $topic_id = $post_info[0]['p_topic_id'];
        $forum_id = $post_info[0]['p_cache_forum_id'];
        $poster = $post_info[0]['p_poster'];
        $post = get_translated_text($post_info[0]['p_post'], $GLOBALS['FORUM_DB']);
    }

    if (!cns_may_moderate_forum($forum_id)) {
        access_denied('I_ERROR');
    }

    $topic_info = $GLOBALS['FORUM_DB']->query_select('f_topics', ['t_cache_first_post_id', 't_pt_from', 't_cache_first_title'], ['id' => $topic_id], '', 1);
    $topic_title = $topic_info['t_cache_first_title'];

    $GLOBALS['FORUM_DB']->query_update('f_posts', [
        'p_validated' => 1,
    ], ['id' => $post_id], '', 1);

    if (!array_key_exists(0, $topic_info)) {
        return $topic_id; // Dodgy, topics gone missing
    }
    $is_starter = ($topic_info[0]['t_cache_first_post_id'] == $post_id);

    $GLOBALS['FORUM_DB']->query_update('f_topics', [ // Validating a post will also validate a topic
        't_validated' => 1,
    ], ['id' => $topic_id], '', 1);

    $_url = build_url(['page' => 'topicview', 'id' => $topic_id], 'forum', [], false, false, true, 'post_' . strval($post_id));
    $url = $_url->evaluate();

    $post_points = 0;
    if ($forum_id !== null) {
        $post_counts = $GLOBALS['FORUM_DB']->query_select_value_if_there('f_forums', 'f_post_count_increment', ['id' => $forum_id]);
        if ($post_counts === 1) {
            cns_force_update_member_post_count($poster, 1);
            require_code('cns_posts_action2');
            cns_member_handle_promotion($poster);
        }

        // Award points when necessary and if not already awarded
        if (($post_counts === 1) && (addon_installed('points')) && (!is_guest($post_info[0]['p_poster'])) && ($post_info[0]['p_intended_solely_for'] === null) && ($topic_info[0]['t_pt_from'] === null)) {
            $already_awarded = $GLOBALS['SITE_DB']->query_select_value_if_there('points_ledger', 'id', ['t_type' => 'post', 't_subtype' => 'add', 't_type_id' => strval($post_id)]);
            if ($already_awarded === null) {
                $post_points = intval(get_option('points_posting'));
                if ($post_points > 0) {
                    require_code('points2');
                    points_credit_member($poster, do_lang('ACTIVITY_ADD_POST', strval($post_id), $topic_title), $post_points, 0, null, 0, 'post', 'add', strval($post_id));
                }
            }
        }
    }

    send_content_validated_notification('post', strval($post_id), $post_points);

    cns_send_topic_notification($url, $topic_id, $post_id, $forum_id, $poster, $is_starter, $post, $topic_info[0]['t_cache_first_title'], null, ($topic_info[0]['t_pt_from'] !== null), null, null, $post_info[0]['p_poster_name_if_guest']);

    if ($forum_id !== null) {
        cns_force_update_forum_caching($forum_id, 0, 1);
    }

    cns_force_update_topic_caching($topic_id, 1, true, true);

    return $topic_id; // Because we might want this
}

/**
 * Edit a post.
 *
 * @param  AUTO_LINK $post_id The ID of the post that we're editing
 * @param  ?BINARY $validated Whether the post is validated (null: decide based on permissions)
 * @param  SHORT_TEXT $title The title of the post (may be blank)
 * @param  LONG_TEXT $post The post
 * @param  BINARY $skip_sig Whether to skip showing the posters signature in the post
 * @param  BINARY $is_emphasised Whether the post is marked emphasised
 * @param  ?MEMBER $intended_solely_for The member that this post is intended solely for (null: none)
 * @param  boolean $show_as_edited Whether to show the post as edited
 * @param  boolean $mark_as_unread Whether to mark the topic as unread by those previous having read this post
 * @param  LONG_TEXT $reason The reason for this action
 * @param  boolean $check_perms Whether to check permissions
 * @param  ?TIME $edit_time Edit time (null: either means current time, or if $null_is_literal, means reset to to null)
 * @param  ?TIME $add_time Add time (null: do not change)
 * @param  ?MEMBER $submitter Submitter (null: do not change)
 * @param  boolean $null_is_literal Determines whether some nulls passed mean 'use a default' or literally mean 'set to null'
 * @param  boolean $run_checks Whether to run checks
 * @param  ?string $poster_name_if_guest The name of the person making the post (null: no change)
 * @return AUTO_LINK The ID of the topic (while this could be known without calling this function, as we've gone to effort and grabbed it from the DB, it might turn out useful for something)
 */
function cns_edit_post(int $post_id, ?int $validated, string $title, string $post, int $skip_sig, int $is_emphasised, ?int $intended_solely_for, bool $show_as_edited, bool $mark_as_unread, string $reason, bool $check_perms = true, ?int $edit_time = null, ?int $add_time = null, ?int $submitter = null, bool $null_is_literal = false, bool $run_checks = true, ?string $poster_name_if_guest = null) : int
{
    if ($edit_time === null) {
        $edit_time = $null_is_literal ? null : time();
    }

    $post_info = $GLOBALS['FORUM_DB']->query_select('f_posts', ['*'], ['id' => $post_id], '', 1);
    if (!array_key_exists(0, $post_info)) {
        warn_exit(do_lang_tempcode('MISSING_RESOURCE', 'post'));
    }
    $_title = $post_info[0]['p_title'];
    $_post = $post_info[0]['p_post'];
    $post_owner = $post_info[0]['p_poster'];
    $forum_id = $post_info[0]['p_cache_forum_id'];
    $topic_id = $post_info[0]['p_topic_id'];

    $topic_info = $GLOBALS['FORUM_DB']->query_select('f_topics', ['t_cache_first_post_id', 't_pt_from', 't_cache_first_title'], ['id' => $topic_id], '', 1);

    require_code('cns_posts_action');
    require_code('cns_posts');
    if ($run_checks) {
        cns_check_post($post);
    }

    if ($check_perms) {
        $closed = ($GLOBALS['FORUM_DB']->query_select_value('f_topics', 't_is_open', ['id' => $topic_id]) == 0);
        if (!cns_may_edit_post_by($post_id, $post_info[0]['p_time'], $post_owner, $forum_id, null, $closed)) {
            access_denied('I_ERROR');
        }
    }

    if (($validated === null) || ($validated == 1)) {
        if (($forum_id !== null) && (!has_privilege(get_member(), 'bypass_validation_lowrange_content', 'topics', ['forums', $forum_id]))) {
            $validated = 0;
        } else {
            $validated = 1;
        }

        if (($mark_as_unread)/* && (cns_may_moderate_forum($forum_id))*/) {
            $cache_last_username = $GLOBALS['FORUM_DRIVER']->get_username($post_owner, true);
            if ($cache_last_username === null) {
                $cache_last_username = do_lang('UNKNOWN');
            }
            $GLOBALS['FORUM_DB']->query_update('f_topics', ['t_cache_last_time' => time(), 't_cache_last_post_id' => $post_id, 't_cache_last_title' => $title, 't_cache_last_username' => $cache_last_username, 't_cache_last_member_id' => $post_owner], ['id' => $topic_id], '', 1);

            $GLOBALS['FORUM_DB']->query_delete('f_read_logs', ['l_topic_id' => $topic_id]);
        }
    }

    // Logging
    require_code('cns_general_action2');
    $moderatorlog_id = cns_mod_log_it('EDIT_POST', strval($post_id), $title, $reason);
    if ((addon_installed('actionlog')) && (addon_installed('cns_forum'))) {
        $ticket_forum = get_option('ticket_forum_name', true);
        if (($ticket_forum === null) || ($forum_id != $GLOBALS['FORUM_DRIVER']->forum_id_from_name($ticket_forum))) {
            require_code('revisions_engine_database');
            $revision_engine = new RevisionEngineDatabase(true);
            $revision_engine->add_revision(
                'post',
                strval($post_id),
                strval($topic_id),
                $_title,
                get_translated_text($_post, $GLOBALS['FORUM_DB']),
                $post_owner,
                $post_info[0]['p_time'],
                $moderatorlog_id
            );
        }
    }

    // Do edit...

    $update_map = [];
    require_code('attachments2');
    require_code('attachments3');
    if (!addon_installed('validation')) {
        $validated = 1;
    }
    $update_map += [
        'p_title' => $title,
        'p_is_emphasised' => $is_emphasised,
        'p_intended_solely_for' => $intended_solely_for,
        'p_validated' => $validated,
        'p_skip_sig' => $skip_sig,
    ];
    $update_map += update_lang_comcode_attachments('p_post', $_post, $post, 'cns_post', strval($post_id), $GLOBALS['FORUM_DB'], $post_owner);
    if ($poster_name_if_guest !== null) {
        $update_map['p_poster_name_if_guest'] = $poster_name_if_guest;
    }

    if ($show_as_edited) {
        $update_map['p_last_edit_time'] = $edit_time;
        $update_map['p_last_edit_by'] = get_member();
    } else {
        $update_map['p_last_edit_time'] = null;
        $update_map['p_last_edit_by'] = null;
    }

    if ($add_time !== null) {
        $update_map['p_time'] = $add_time;
    }
    if ($submitter !== null) {
        $update_map['p_poster'] = $submitter;
    }

    $GLOBALS['FORUM_DB']->query_update('f_posts', $update_map, ['id' => $post_id], '', 1);

    // Update topic caching...

    $info = $GLOBALS['FORUM_DB']->query_select('f_topics', ['t_cache_first_post_id', 't_cache_first_title'], ['id' => $topic_id], '', 1);
    if ((array_key_exists(0, $info)) && ($info[0]['t_cache_first_post_id'] == $post_id) && ($info[0]['t_cache_first_title'] != $title)) {
        require_code('urls2');
        suggest_new_idmoniker_for('topicview', 'browse', strval($topic_id), '', $title);

        $GLOBALS['FORUM_DB']->query_update('f_topics', ['t_cache_first_title' => $title], ['id' => $topic_id], '', 1);
    }

    if ($forum_id !== null) {
        cns_decache_cms_blocks($forum_id);
    }

    // Award points when necessary and if not already awarded
    if (($validated == 1) && (addon_installed('points')) && (!is_guest($post_info[0]['p_poster'])) && ($post_info[0]['p_intended_solely_for'] === null) && ($topic_info[0]['t_pt_from'] === null)) {
        $already_awarded = $GLOBALS['SITE_DB']->query_select_value_if_there('points_ledger', 'id', ['t_type' => 'post', 't_subtype' => 'add', 't_type_id' => strval($post_id)]);
        if ($already_awarded === null) {
            $post_points = intval(get_option('points_posting'));
            if ($post_points > 0) {
                require_code('points2');
                points_credit_member($post_owner, do_lang('ACTIVITY_ADD_POST', strval($post_id), $info[0]['t_cache_first_title']), $post_points, 0, null, 0, 'post', 'add', strval($post_id));
            }
        }
    }

    if ((addon_installed('commandr')) && (!running_script('install')) && (!get_mass_import_mode())) {
        require_code('resource_fs');
        generate_resource_fs_moniker('post', strval($post_id));
    }

    return $topic_id; // We may want this
}

/**
 * Delete posts from a topic.
 *
 * @param  AUTO_LINK $topic_id The ID of the topic we're deleting posts from
 * @param  array $posts A list of posts to delete
 * @param  LONG_TEXT $reason The reason for this action
 * @param  boolean $check_perms Whether to check permissions
 * @param  boolean $cleanup Whether to do a cleanup: delete the topic if there will be no posts left in it
 * @param  boolean $save_revision Whether to save a revision
 * @param  boolean $reverse_point_transactions Whether to also reverse any relevant point transactions for deleted posts
 * @return boolean Whether the topic was deleted, due to all posts in said topic being deleted
 */
function cns_delete_posts_topic(int $topic_id, array $posts, string $reason = '', bool $check_perms = true, bool $cleanup = true, bool $save_revision = true, bool $reverse_point_transactions = true) : bool
{
    if (empty($posts)) {
        return false;
    }

    // Info about source
    $info = $GLOBALS['FORUM_DB']->query_select('f_topics', ['t_forum_id', 't_pt_from', 't_pt_to'], ['id' => $topic_id], '', 1);
    if (!array_key_exists(0, $info)) {
        warn_exit(do_lang_tempcode('MISSING_RESOURCE', 'topic'));
    }
    $forum_id = $info[0]['t_forum_id'];

    $or_list = '';
    foreach ($posts as $post) {
        if ($or_list != '') {
            $or_list .= ' OR ';
        }

        $or_list .= 'id=' . strval($post);

        if (addon_installed('catalogues')) {
            update_catalogue_content_ref('post', strval($post), '');
        }
    }

    // Check access
    $start = 0;
    $max = 250;
    do {
        $_postdetails = $GLOBALS['FORUM_DB']->query('SELECT * FROM ' . $GLOBALS['FORUM_DB']->get_table_prefix() . 'f_posts WHERE ' . $or_list, $max, $start, false, true);
        $num_posts_counted = 0;
        foreach ($_postdetails as $post) {
            if (($post['p_intended_solely_for'] === null) && ($post['p_validated'] == 1)) {
                $num_posts_counted++;
            }
            $post_owner = $post['p_poster'];
            if ($check_perms) {
                if (!cns_may_delete_post_by($post['id'], $post['p_time'], $post_owner, $forum_id)) {
                    access_denied('I_ERROR');
                }
            }
        }

        $start += $max;
    } while (!empty($_postdetails));

    // Logging
    require_code('cns_general_action2');
    if (count($posts) == 1) {
        $moderatorlog_id = cns_mod_log_it('DELETE_POST', strval($topic_id), strval($posts[0]), $reason);
    } else {
        $moderatorlog_id = cns_mod_log_it('DELETE_POSTS', strval($topic_id), strval(count($posts)), $reason);
    }
    if ((addon_installed('actionlog')) && ($save_revision) && (addon_installed('cns_forum'))) {
        require_code('revisions_engine_database');
        foreach ($_postdetails as $post) {
            $revision_engine = new RevisionEngineDatabase(true);
            $revision_engine->add_revision(
                'post',
                strval($post['id']),
                strval($topic_id),
                $post['p_title'],
                get_translated_text($post['p_post'], $GLOBALS['FORUM_DB']),
                $post['p_poster'],
                $post['p_time'],
                $moderatorlog_id
            );
        }
    }

    // Update member post counts
    if ($forum_id === null) {
        $post_counts = 1;
    } else {
        $post_counts = $GLOBALS['FORUM_DB']->query_select_value_if_there('f_forums', 'f_post_count_increment', ['id' => $forum_id]);
        if ($post_counts === null) {
            $post_counts = 1;
        }
    }
    if ($post_counts == 1) {
        $sql = 'SELECT p_poster FROM ' . $GLOBALS['FORUM_DB']->get_table_prefix() . 'f_posts WHERE (' . $or_list . ')';
        if (addon_installed('validation')) {
            $sql .= ' AND p_validated=1';
        }
        $_member_post_counts = $GLOBALS['FORUM_DB']->query($sql, null, 0, false, true);
        $member_post_counts = [];
        foreach ($_member_post_counts as $_member_post_count) {
            $_member = $_member_post_count['p_poster'];
            if (!array_key_exists($_member, $member_post_counts)) {
                $member_post_counts[$_member] = 0;
            }
            $member_post_counts[$_member]++;
        }

        foreach ($member_post_counts as $member_id => $member_post_count) {
            if ($forum_id !== null) {
                require_code('cns_posts_action');
                cns_force_update_member_post_count($member_id, -$member_post_count);
            }
        }
    }

    // Clean up lang
    require_code('attachments2');
    require_code('attachments3');
    foreach ($_postdetails as $post) {
        delete_lang_comcode_attachments($post['p_post'], 'cns_post', strval($post['id']), $GLOBALS['FORUM_DB']);
    }

    // Delete everything...

    $GLOBALS['FORUM_DB']->query('DELETE FROM ' . $GLOBALS['FORUM_DB']->get_table_prefix() . 'f_posts WHERE ' . $or_list, null, 0, false, true);
    $GLOBALS['SITE_DB']->query('DELETE FROM ' . $GLOBALS['SITE_DB']->get_table_prefix() . 'review_supplement WHERE ' . str_replace('id=', 'r_post_id=', $or_list), null, 0, false, true);

    $test = $GLOBALS['FORUM_DB']->query_select_value('f_posts', 'COUNT(*)', ['p_topic_id' => $topic_id]);
    if (($test == 0) && ($cleanup)) {
        require_code('cns_topics_action');
        require_code('cns_topics_action2');
        cns_delete_topic($topic_id, do_lang('DELETE_POSTS')); // We will be reversing the points later, so don't reverse them here
        $ret = true;
    } else {
        $ret = false;

        // Update caching
        require_code('cns_posts_action2');
        cns_force_update_topic_caching($topic_id, -$num_posts_counted, true, true);
        if ($forum_id !== null) {
            require_code('cns_posts_action2');
            cns_force_update_forum_caching($forum_id, 0, -$num_posts_counted);
        }
    }

    if (addon_installed('search')) {
        require_code('database_search');
        foreach ($_postdetails as $post) {
            if ($forum_id === null) {
                Composr_fast_custom_index::delete_from_index($GLOBALS['FORUM_DB'], 'f_pposts_fulltext_index', ['i_post_id' => $post['id']]);
            } else {
                Composr_fast_custom_index::delete_from_index($GLOBALS['FORUM_DB'], 'f_posts_fulltext_index', ['i_post_id' => $post['id']]);
            }
        }
    }

    // Reverse points if applicable
    if (($reverse_point_transactions) && (addon_installed('points'))) {
        require_code('points2');
        foreach ($posts as $post) {
            points_transactions_reverse_all(true, null, null, 'post', 'add', strval($post));
        }
    }

    require_code('cns_posts_action');
    if ($forum_id !== null) {
        cns_decache_cms_blocks($forum_id);
    } else {
        decache_private_topics($info[0]['t_pt_from']);
        decache_private_topics($info[0]['t_pt_to']);
    }

    if ((addon_installed('commandr')) && (!running_script('install')) && (!get_mass_import_mode())) {
        require_code('resource_fs');
        foreach ($posts as $post) {
            expunge_resource_fs_moniker('post', strval($post));
        }
    }

    return $ret;
}

/**
 * Move posts from one topic to another.
 *
 * @param  AUTO_LINK $from_topic_id The ID of the source topic
 * @param  ?AUTO_LINK $to_topic_id The ID of the destination topic (null: move to new topic in $forum_id)
 * @param  array $posts A list of post IDs to move
 * @param  LONG_TEXT $reason The reason for this action
 * @param  ?AUTO_LINK $to_forum_id The forum the destination topic is in (null: find from DB)
 * @param  boolean $delete_if_empty Whether to delete the topic if all posts in it have been moved
 * @param  ?SHORT_TEXT $title The title for the new topic (null: work out / irrelevant)
 * @return boolean Whether the topic was deleted
 */
function cns_move_posts(int $from_topic_id, ?int $to_topic_id, array $posts, string $reason, ?int $to_forum_id = null, bool $delete_if_empty = false, ?string $title = null) : bool
{
    // Info about source
    $from_info = $GLOBALS['FORUM_DB']->query_select('f_topics', ['t_forum_id'], ['id' => $from_topic_id]);
    if (!array_key_exists(0, $from_info)) {
        warn_exit(do_lang_tempcode('MISSING_RESOURCE', 'topic'));
    }
    $from_forum_id = $from_info[0]['t_forum_id'];

    // Useful for queries
    $or_list = '';
    foreach ($posts as $post) {
        if ($or_list != '') {
            $or_list .= ' OR ';
        }
        $or_list .= 'id=' . strval($post);
    }

    // Check access
    if (!cns_may_moderate_forum($from_forum_id)) {
        access_denied('I_ERROR');
    }
    $_postdetails = $GLOBALS['FORUM_DB']->query('SELECT p_cache_forum_id,p_intended_solely_for,p_validated FROM ' . $GLOBALS['FORUM_DB']->get_table_prefix() . 'f_posts WHERE ' . $or_list, null, 0, false, true);
    $num_posts_counted = 0;
    foreach ($_postdetails as $post) {
        if (($post['p_intended_solely_for'] === null) && ($post['p_validated'] == 1)) {
            $num_posts_counted++;
        }
        if ($post['p_cache_forum_id'] != $from_forum_id) {
            fatal_exit(do_lang_tempcode('INTERNAL_ERROR'));
        }
    }

    // Is it a support ticket move?
    if (addon_installed('tickets')) {
        require_code('tickets');
        $is_support_ticket = (is_ticket_forum($from_forum_id)) && (is_ticket_forum($to_forum_id));
    } else {
        $is_support_ticket = false;
    }

    // Create topic, if this is a split
    if ($to_topic_id === null) {
        if ($to_forum_id === null) {
            fatal_exit(do_lang_tempcode('INTERNAL_ERROR'));
        }

        if ($is_support_ticket) {
            // For support tickets, we need to make the spacer post
            require_lang('tickets');
            require_code('tickets');
            require_code('tickets2');
            $member_id = get_member();
            foreach ($posts as $post) {
                $member_id = $GLOBALS['FORUM_DB']->query_select_value('f_posts', 'p_poster', ['id' => $posts[0]]);
                if ($member_id != get_member()) {
                    break;
                }
            }
            $ticket_id = ticket_generate_new_id($member_id);
            $ticket_type = $GLOBALS['SITE_DB']->query_select_value('tickets', 'ticket_type', ['topic_id' => $from_topic_id]);
            if ($title === null) {
                $title = $GLOBALS['FORUM_DB']->query_select_value('f_posts', 'p_title', ['id' => $posts[0]]);
            }
            $ticket_url = ticket_add_post($ticket_id, $ticket_type, $title, '', false, $member_id);
            $to_topic_id = $GLOBALS['LAST_TOPIC_ID'];
            $GLOBALS['FORUM_DB']->query('UPDATE ' . $GLOBALS['FORUM_DB']->get_table_prefix() . 'f_posts SET p_time=' . strval(time()) . ' WHERE ' . $or_list, null, 0, false, true);
        } else {
            require_code('cns_topics_action');
            $to_topic_id = cns_make_topic($to_forum_id);
        }

        if (($title !== null) && (!empty($posts))) {
            $GLOBALS['FORUM_DB']->query_update('f_posts', ['p_title' => $title], ['id' => $posts[0]], '', 1);
        }
    }

    // Info about destination
    $to_info = $GLOBALS['FORUM_DB']->query_select('f_topics', ['t_forum_id'], ['id' => $to_topic_id]);
    if (!array_key_exists(0, $to_info)) {
        warn_exit(do_lang_tempcode('MISSING_RESOURCE', 'topic'));
    }
    $to_forum_id = $to_info[0]['t_forum_id'];

    // Do move
    $GLOBALS['FORUM_DB']->query('UPDATE ' . $GLOBALS['FORUM_DB']->get_table_prefix() . 'f_posts SET p_cache_forum_id=' . strval($to_forum_id) . ', p_topic_id=' . strval($to_topic_id) . ' WHERE ' . $or_list, null, 0, false, true);

    // Update caching
    if (addon_installed('actionlog')) {
        require_code('revisions_engine_database');
        $revision_engine = new RevisionEngineDatabase();
        foreach ($posts as $post) {
            $revision_engine->recategorise_old_revisions('post', strval($post), strval($to_topic_id));
        }
    }
    require_code('cns_posts_action2');
    cns_force_update_topic_caching($from_topic_id, -$num_posts_counted, true, true);
    cns_force_update_topic_caching($to_topic_id, $num_posts_counted, true, true);
    if (($from_forum_id !== null) && ($to_topic_id !== null) && ($from_forum_id != $to_topic_id)) {
        if ($from_forum_id != $to_forum_id) {
            require_code('cns_forums_action2');
            cns_force_update_forum_caching($from_forum_id, 0, -$num_posts_counted);
            cns_force_update_forum_caching($to_forum_id, 0, $num_posts_counted);

            // Update member post counts if we've switched between post-count countable forums
            $post_count_info = $GLOBALS['FORUM_DB']->query('SELECT id,f_post_count_increment FROM ' . $GLOBALS['FORUM_DB']->get_table_prefix() . 'f_forums WHERE id=' . strval($from_forum_id) . ' OR id=' . strval($to_forum_id), 2);
            if ($post_count_info[0]['id'] == $from_forum_id) {
                $from = $post_count_info[0]['f_post_count_increment'];
                $to = $post_count_info[1]['f_post_count_increment'];
            } else {
                $from = $post_count_info[1]['f_post_count_increment'];
                $to = $post_count_info[0]['f_post_count_increment'];
            }
            if ($from != $to) {
                $sql = 'SELECT p_poster FROM ' . $GLOBALS['FORUM_DB']->get_table_prefix() . 'f_posts WHERE (' . $or_list . ')';
                if (addon_installed('validation')) {
                    $sql .= ' AND p_validated=1';
                }
                $_member_post_counts = collapse_1d_complexity('p_poster', $GLOBALS['FORUM_DB']->query($sql, null, 0, false, true));
                $member_post_counts = array_count_values($_member_post_counts);

                foreach ($member_post_counts as $member_id => $member_post_count) {
                    if ($to == 0) {
                        $member_post_count = -$member_post_count;
                    }
                    cns_force_update_member_post_count($member_id, $member_post_count);
                }
            }
        }
    }

    // Delete if needed
    $test = $delete_if_empty ? $GLOBALS['FORUM_DB']->query_select_value('f_posts', 'COUNT(*)', ['p_topic_id' => $from_topic_id]) : 1;
    if ($test == 0) {
        $num_view_count = 0;
        $num_view_count += $GLOBALS['FORUM_DB']->query_select_value('f_topics', 't_num_views', ['id' => $from_topic_id]);
        $num_view_count += $GLOBALS['FORUM_DB']->query_select_value('f_topics', 't_num_views', ['id' => $to_topic_id]);
        $GLOBALS['FORUM_DB']->query_update('f_topics', ['t_num_views' => $num_view_count], ['id' => $to_topic_id], '', 1);

        require_code('cns_topics_action');
        require_code('cns_topics_action2');
        cns_delete_topic($from_topic_id, do_lang('MOVE_POSTS')); // Do not reverse points when moving posts
        return true;
    }

    // Make informative post
    $topic_title = $GLOBALS['FORUM_DB']->query_select_value('f_topics', 't_cache_first_title', ['id' => $to_topic_id]);
    if ($is_support_ticket) {
        $to_link = '[page="' . get_module_zone('tickets') . ':tickets:ticket:' . $ticket_id . '"]' . str_replace('"', '\"', str_replace('[', '\\[', $topic_title)) . '[/page]';
    } else {
        $to_link = '[page="' . get_module_zone('topicview') . ':topicview:browse:' . strval($to_topic_id) . '"]' . str_replace('"', '\"', str_replace('[', '\\[', $topic_title)) . '[/page]';
    }
    $me_link = '[page="' . get_module_zone('members') . ':members:view:' . strval(get_member()) . '"]' . $GLOBALS['CNS_DRIVER']->get_username(get_member(), true) . '[/page]';
    $lang = do_lang('INLINE_POSTS_MOVED_MESSAGE', $me_link, integer_format(count($posts), 0), [$to_link, get_timezoned_date_time(time())]);
    require_code('cns_posts_action');
    cns_make_post($from_topic_id, '', $lang, 0, false, 1, 1, null, null, $GLOBALS['FORUM_DB']->query_select_value('f_posts', 'p_time', ['id' => $posts[0]]) + 1, null, null, null, null, false);

    require_code('cns_general_action2');
    cns_mod_log_it('MOVE_POSTS', strval($to_topic_id), strval(count($posts)), $reason);

    if ($from_forum_id !== null) {
        cns_decache_cms_blocks($from_forum_id);
    }
    if ($to_forum_id !== null) {
        cns_decache_cms_blocks($to_forum_id);
    }

    return false;
}
