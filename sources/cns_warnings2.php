<?php /*

 Composr
 Copyright (c) Christopher Graham, 2004-2024

 See docs/LICENSE.md for full licensing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

/**
 * @license    http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright  Christopher Graham
 * @package    cns_warnings
 */

/**
 * Standard code module initialisation function.
 *
 * @ignore
 */
function init__cns_warnings2()
{
    require_code('cns_warnings');
}

/**
 * Add a warning.
 * Punitive actions must be added to the warning separately via systems/cns_warnings hooks.
 *
 * @param  MEMBER $member_id The member being warned
 * @param  LONG_TEXT $explanation An explanation for why the member is being warned
 * @param  ?MEMBER $by The member doing the warning (null: current member)
 * @param  ?TIME $time The time of the warning (null: now)
 * @param  BINARY $is_warning Whether this counts as a formal warning
 * @return AUTO_LINK The ID of the new warning
 */
function cns_make_warning(int $member_id, string $explanation, ?int $by = null, ?int $time = null, int $is_warning = 1) : int
{
    if (!addon_installed('cns_warnings')) {
        warn_exit(do_lang_tempcode('MISSING_ADDON', escape_html('cns_warnings')));
    }

    if ($time === null) {
        $time = time();
    }
    if ($by === null) {
        $by = get_member();
    }

    if ($is_warning == 1) {
        $GLOBALS['FORUM_DB']->query('UPDATE ' . $GLOBALS['FORUM_DB']->get_table_prefix() . 'f_members SET m_cache_warnings=(m_cache_warnings+1) WHERE id=' . strval($member_id), 1);
    }

    $map = [
        'w_member_id' => $member_id,
        'w_time' => $time,
        'w_explanation' => $explanation,
        'w_issuing_member' => $by,
        'w_is_warning' => $is_warning,
        'w_topic_id' => null,
    ];

    $id = $GLOBALS['FORUM_DB']->query_insert('f_warnings', $map, true);

    require_code('cns_general_action2');
    require_code('global4');
    set_related_warning_id($id);
    cns_mod_log_it('ADD_WARNING', strval($id), strval($member_id));
    set_related_warning_id(null);

    return $id;
}

/**
 * Edit a formal warning.
 *
 * @param  AUTO_LINK $warning_id The ID of the formal warning we are editing
 * @param  LONG_TEXT $explanation An explanation for why the member is being warned
 * @param  BINARY $is_warning Whether this counts as a warning
 * @return AUTO_LINK The member ID the warning was for
 */
function cns_edit_warning(int $warning_id, string $explanation, int $is_warning = 1) : int
{
    if (!addon_installed('cns_warnings')) {
        warn_exit(do_lang_tempcode('MISSING_ADDON', escape_html('cns_warnings')));
    }

    $member_id = $GLOBALS['FORUM_DB']->query_select_value_if_there('f_warnings', 'w_member_id', ['id' => $warning_id]);
    if ($member_id === null) {
        warn_exit(do_lang_tempcode('MISSING_RESOURCE'));
    }

    $GLOBALS['FORUM_DB']->query_update('f_warnings', ['w_explanation' => $explanation, 'w_is_warning' => $is_warning], ['id' => $warning_id], '', 1);

    $member_id = $GLOBALS['FORUM_DB']->query_select_value('f_warnings', 'w_member_id', ['id' => $warning_id]);
    $num_warnings = $GLOBALS['FORUM_DB']->query_select_value('f_warnings', 'COUNT(*)', ['w_is_warning' => 1, 'w_member_id' => $member_id]);

    $GLOBALS['FORUM_DB']->query_update('f_members', ['m_cache_warnings' => $num_warnings], ['id' => $member_id], '', 1);

    require_code('cns_general_action2');
    cns_mod_log_it('EDIT_WARNING', strval($warning_id), strval($member_id));

    return $member_id;
}

/**
 * Delete a formal warning.
 *
 * @param  AUTO_LINK $warning_id The ID of the formal warning we are deleting
 * @return AUTO_LINK The member ID the warning was for
 */
function cns_delete_warning(int $warning_id) : int
{
    if (!addon_installed('cns_warnings')) {
        warn_exit(do_lang_tempcode('MISSING_ADDON', escape_html('cns_warnings')));
    }

    $member_id = $GLOBALS['FORUM_DB']->query_select_value_if_there('f_warnings', 'w_member_id', ['id' => $warning_id]);
    if ($member_id === null) {
        warn_exit(do_lang_tempcode('MISSING_RESOURCE'));
    }

    $GLOBALS['FORUM_DB']->query_delete('f_warnings', ['id' => $warning_id], '', 1);

    $num_warnings = $GLOBALS['FORUM_DB']->query_select_value('f_warnings', 'COUNT(*)', ['w_is_warning' => 1, 'w_member_id' => $member_id]);
    $GLOBALS['FORUM_DB']->query_update('f_members', ['m_cache_warnings' => $num_warnings], ['id' => $member_id], '', 1);

    require_code('cns_general_action2');
    cns_mod_log_it('DELETE_WARNING', strval($warning_id), strval($member_id));

    return $member_id;
}
