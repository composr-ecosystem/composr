<?php /*

 Composr
 Copyright (c) ocProducts, 2004-2021

 See docs/LICENSE.md for full licensing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

/**
 * @license    http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright  ocProducts Ltd
 * @package    points
 */

/**
 * See if a leader-board has been calculated since a particular cut-off time.
 *
 * @param  TIME $cutoff Cut-off time
 * @return boolean Whether it has
 */
function has_leader_board_since(int $cutoff) : bool
{
    $test = $GLOBALS['SITE_DB']->query_value_if_there('SELECT COUNT(*) FROM ' . get_table_prefix() . 'leader_board WHERE date_and_time>=' . strval($cutoff));
    return ($test > 0);
}

/**
 * Check all leader-boards and generate a new result set when applicable.
 */
function calculate_all_leader_boards()
{
    $rows = $GLOBALS['SITE_DB']->query('SELECT * FROM ' . get_table_prefix() . 'leader_boards');
    foreach ($rows as $row) {
        calculate_leader_board($row, false);
    }
}

/**
 * Calculate the leader-boards.
 *
 * @param  array $row The leader-board row to calculate
 * @return ?array A map of member-IDs to points, sorted by leader-board status (null: not retrieving)
 */
function calculate_leader_board(array $row) : ?array
{
    // Calculate cutoff time based on site timezone
    $old_timezone = @date_default_timezone_get();
    date_default_timezone_set(get_site_timezone());
    $cutoff_string = '-1 week';
    $cutoff = time() - (60 * 60 * 24 * 7);
    $start = time();
    switch ($row['lb_timeframe']) {
        case 'week':
            $cutoff_string = '-1 week';
            $cutoff = strtotime($cutoff_string); // Default to one week ago
            if ($row['lb_rolling'] === '0') { // Do not roll; cut off at the start of the week instead
                if (get_option('ssw') === '0') { // Week starts Monday
                    $cutoff = strtotime('last monday');
                } else { // Week starts Sunday
                    $cutoff = strtotime('last sunday');
                }
            }
            break;
        case 'month':
            $cutoff_string = '-1 month';
            $cutoff = strtotime($cutoff_string); // Default to 1 month ago from now
            if ($row['lb_rolling'] === '0') { // Do not roll; cut off at the start of the week instead
                $cutoff = strtotime("first day of this month");
            }
            break;
        case 'year':
            $cutoff_string = '-1 year';
            $cutoff = strtotime($cutoff_string); // Default to 1 month ago from now
            if ($row['lb_rolling'] === '0') { // Do not roll; cut off at the start of the week instead
                $cutoff = strtotime("January 1");
            }
            break;
    }
    if ($cutoff > time()) { // Sometimes if today matches the condition, then the timestamp will be in the future; roll back to midnight
        $cutoff = strtotime('midnight');
    }
    $start = strtotime($cutoff_string, $cutoff);
    date_default_timezone_set($old_timezone);

    if (has_leader_board_since($cutoff)) {
        return null; // Nothing to do; too soon to generate a new leader board
    }

    // Calculate

    $limit = $row['lb_member_count']; // The number to show on the leader-board
    $show_staff = $row['lb_include_staff']; // Whether to include staff

    $points = [];

    $rows = [];
    $current_id = 1;
    do {
        $rows = $GLOBALS['FORUM_DRIVER']->get_next_members($current_id, 100);
        foreach ($rows as $member) {
            $current_id = $GLOBALS['FORUM_DRIVER']->mrow_id($member);
            if (is_guest($current_id)) {
                continue; // Should not happen, but some forum drivers might suck ;)
            }
            if ((!$show_staff) && ($GLOBALS['FORUM_DRIVER']->is_staff($current_id))) {
                continue;
            }

            // TODO left off here
            $points_then = total_points($current_id, $start, false);
            $points_now = total_points($current_id, $cutoff, false);
            $points_earned = $points_now - $points_then;

            $points[$current_id] = $points_earned;
        }
    } while (count($rows) > 0);

    arsort($points);

    $rows = [];

    $i = 0;
    $time = time();
    foreach ($points as $id => $num_points) {
        $username = $GLOBALS['FORUM_DRIVER']->get_username($id, false, USERNAME_DEFAULT_NULL);
        if ($username === null) {
            continue;
        }

        if ($i == 0) {
            set_value('site_bestmember', $username);
        }

        if ($i >= $limit) {
            break;
        }

        $row = ['lb_member' => $id, 'lb_points' => $num_points, 'date_and_time' => $time];
        $GLOBALS['SITE_DB']->query_insert('leader_board', $row, false, true); // Allow failure due to race conditions

        $i++;
    }

    if (!$retrieve) {
        return null;
    }

    return $rows;
}
