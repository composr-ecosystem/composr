<?php /*

 Composr
 Copyright (c) Christopher Graham, 2004-2024

 See docs/LICENSE.md for full licensing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

/**
 * @license    http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright  Christopher Graham
 * @package    core
 */

/**
 * Endpoint API entry script.
 */
function endpoint_script()
{
    prepare_backend_response(null, BACKEND_RESPONSE_NOINDEX | BACKEND_RESPONSE_CSP_SUPER_STRICT);

    cms_ini_set('ocproducts.xss_detect', '0');

    $hook_type = mixed();
    $hook = mixed();
    $type = mixed();
    $id = mixed();

    $hook_type = false;
    $hook = false;
    //$type = false; Is optional, so let it pass null as a default instead of false (=error)
    //$id = false; Is optional, so let it pass null as a default instead of false (=error)

    $response_type = 'json';

    require_code('failure');
    set_throw_errors(true);

    try {
        // Restful
        if (!@cms_empty_safe($_SERVER['PATH_INFO'])) {
            // What response type is desired
            if (!empty($_SERVER['HTTP_ACCEPT'])) {
                if (strpos($_SERVER['HTTP_ACCEPT'], 'json') !== false) {
                    $response_type = 'json';
                }
                // ... Currently we actually only support JSON anyway! No need for unnecessary complexity.
            }

            // Path-info is translated to $hook_type/$hook/$id
            $path_info = $_SERVER['PATH_INFO'];
            $matches = [];
            if (preg_match('#^(/\w+)(/\w+)?(/.+)?#', $path_info, $matches) != 0) {
                $hook_type = ltrim($matches[1], '/');
                $hook = isset($matches[2]) ? ltrim($matches[2], '/') : false;
                $id = isset($matches[3]) ? ltrim($matches[3], '/') : null;
            }

            // POST data may need switching about
            if (empty($_POST)) {
                if ($_SERVER['REQUEST_METHOD'] != 'HEAD' && $_SERVER['REQUEST_METHOD'] != 'GET') { // i.e. not a simple CSRF case
                    $_POST['data'] = @file_get_contents('php://input');
                }
            }

            // Convert from REST's use of standard HTTP verbs to the software's standard $type names (also corresponds with CRUD)
            switch (cms_strtoupper_ascii($_SERVER['REQUEST_METHOD'])) {
                case 'POST': // REST POST = CRUD create = software add
                    $type = 'add';
                    break;

                case 'PUT': // REST PUT = CRUD update = software edit
                    $type = 'edit';
                    break;

                case 'DELETE': // REST DELETE = CRUD delete = software delete
                    $type = 'delete';
                    break;

                case 'GET': // REST GET = N/A = software view
                default:
                    $type = 'view';
                    break;
            }
        }

        // GET params take priority
        $hook_type = filter_naughty_harsh(get_param_string('hook_type', $hook_type), true);
        $hook = filter_naughty_harsh(get_param_string('hook', $hook), true);
        $type = get_param_string('type', $type);
        $id = get_param_string('id', $id);
        $response_type = get_param_string('response_type', $response_type);

        // Get hook info
        $ob = get_hook_ob('endpoints', $hook_type, $hook, 'Hook_endpoint_' . $hook_type . '_');
        $info = $ob->info($type, $id);

        // Authorize if the endpoint requires it
        if (isset($info['authorization']) && ($info['authorization'] !== false)) {
            $authorized = false;
            $member = null;

            // Try member authorization
            if (!empty(array_intersect(['member', 'staff', 'super_admin'], $info['authorization']))) {
                if (!@cms_empty_safe($_SERVER['PHP_AUTH_USER']) && !@cms_empty_safe($_SERVER['PHP_AUTH_PW'])) {
                    $login_array = $GLOBALS['FORUM_DRIVER']->authorise_login($_SERVER['PHP_AUTH_USER'], null, $_SERVER['PHP_AUTH_PW']);
                    $member = $login_array['id'];
                    if ($member !== null) {
                        if (in_array('member', $info['authorization'])) {
                            $authorized = true;
                        } elseif (in_array('staff', $info['authorization'])) {
                            $authorized = $GLOBALS['FORUM_DRIVER']->is_staff($member);
                        } elseif (in_array('super_admin', $info['authorization'])) {
                            $authorized = $GLOBALS['FORUM_DRIVER']->is_super_admin($member);
                        }
                    }
                }
            }

            // Try maintenance password authorization (should be last as this may cause an exit on failure)
            if ((!$authorized) && in_array('maintenance_password', $info['authorization']) && (preg_match('#^Basic #', $_SERVER['HTTP_AUTHORIZATION']) != 0)) {
                $password_given = base64_decode(substr($_SERVER['HTTP_AUTHORIZATION'], 6));
                if (strpos($password_given, STRING_MAGIC_NULL_BASE64) === 0) { // STRING_MAGIC_NULL is used to indicate no username
                    $password_given = substr($password_given, strlen(STRING_MAGIC_NULL_BASE64));
                }
                require_code('crypt_master');
                if (check_maintenance_password($password_given)) {
                    $authorized = true;
                    require_code('users_active_actions');
                    $member = get_first_admin_user();
                }
            }

            if (($authorized) && ($member !== null)) {
                require_code('users_inactive_occasionals');
                create_session($member);
            } else {
                access_denied();
            }
        }

        // Run the endpoint
        $result = $ob->run($type, $id);

        // Process into output structure
        $return_data = [
            'success' => isset($result['success']) ? $result['success'] : true,
            'error_details' => isset($result['error_details']) ? $result['error_details'] : null,
            'response_data' => array_diff_key($result, ['success' => true, 'error_details' => true]),
        ];
    } catch (Exception $e) {
        // TODO: error log?
        $return_data = [
            'success' => false,
            'error_details' => strip_html($e->getMessage()),
            'response_data' => [],
        ];
    }

    // Output
    switch ($response_type) {
        case 'json':
            @header('Content-Type: application/json; charset=' . get_charset());
            echo json_encode($return_data);
            break;

        default:
            fatal_exit(do_lang_tempcode('JSON_ONLY'));
            break;
    }
}
